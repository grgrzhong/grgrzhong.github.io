{
  "hash": "90a240ecdc05db844a9e3c4ef4f0bce8",
  "result": {
    "markdown": "---\ntitle: \"A comprehensive single-cell map of T cell exhaustion-associated immune environments in human breast cancer\"\ndate: 2024-04-03\ndate-modified: last-modified\ncategories:\n  - scrna\n  - paper\nimage: BCexh.png\n# description: All the learning materials are from credited or adapted from Harvard Chan Bioinformatics Core. \nexecute: \n  freeze: auto\n  eval: false\n---\n\n\n\n\n## Load libraries and data setup\n\n::: {.cell}\n\n```{.r .cell-code}\n### Install and Load required packages\n# if (!any(rownames(installed.packages()) == \"DoubletFinder\")){\n#   remotes::install_github('chris-mcginnis-ucsf/DoubletFinder')\n# }\n\nlibrary(fs)\nlibrary(here)\nlibrary(patchwork)\nlibrary(tidyverse)\nlibrary(readxl)\nlibrary(ggpubr)\nlibrary(rstatix)\nlibrary(Seurat)\nlibrary(DoubletFinder)\nlibrary(magrittr)\nlibrary(clustree)\nlibrary(magrittr)\nlibrary(RColorBrewer)\nlibrary(corrplot)\nlibrary(pheatmap)\nlibrary(ComplexHeatmap)\nlibrary(scales)\nlibrary(viridis)\nlibrary(circlize)\nlibrary(ggrepel)\nlibrary(edgeR)\n\noptions(future.globals.maxSize = 8e9)\noutput_path <- here(\"projects/2023_NC_BCexh/BCexh_scRNAseq/output\")\n```\n:::\n\n\n## Preprocess scRNAseq Data \n\n\n### Save raw Data\n\n[](raw_matrix.png)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n### Project directory\nproject_dir <- here(\"projects/2023_NC_BCexh\")\n\n### Directory for scRNA data\ninput_path <- here(project_dir, \"BCexh_scRNAseq/data\")\noutput_path <- here(\"projects/2023_NC_BCexh/BCexh_scRNAseq/output\")\n\n### Get a list of sample names for creating seurat object from clinical info\nsample_list <- read_excel(\n    here(project_dir, \"supp_data\", \"Supplementary Data1.xlsx\"),\n    ### start from row3\n    skip = 2\n) |>\n    pull(\"Patient ID\") |>\n    map_chr(~ glue::glue(\"T{.x}\"))\n\n### load data to a list\nobj_list <- list()\nfor (sample in sample_list) {\n\n    ### Read counts matrix\n    counts <- read.table(\n        here(input_path, paste0(sample, \"_singlecell_count_matrix.txt\")),\n        sep = \"\\t\"\n    )\n\n    ### Create seurat object\n    obj <- CreateSeuratObject(\n        counts = counts,\n        min.cells = 5, min.features = 200, project = sample\n    )\n\n    ### Retrieve cell barcodes after filtering\n    cell_ids <- colnames(obj)\n\n    ### Read metadata with annotation\n    metadata <- read.table(\n        here(input_path, paste0(sample, \"_complete_singlecell_metadata.txt\")),\n        sep = \"\\t\",\n        header = TRUE\n    )\n\n    ### Align the cell barcode\n    metadata <- metadata |>\n        separate_wider_delim(\n            cellID, delim = \"_\", names = c(\"sample_id\", \"cell_barcode\"),\n            cols_remove = FALSE\n        ) |>\n        mutate(cell_barcode = paste0(cell_barcode, \".1\")) |>\n        column_to_rownames(var = \"cell_barcode\") |>\n        select(-sample_id)\n\n    metadata <- metadata[cell_ids, ]\n\n    metadata$nCount_RNA <- obj$nCount_RNA\n    metadata$nFeature_RNA <- obj$nFeature_RNA\n\n    # all(rownames(metadata) == colnames(obj))\n\n    ### Assign metadata with new cell barcode\n    # obj <- AddMetaData(object = obj, metadata = metadata)\n\n    obj@meta.data <- metadata\n\n    ### Save new obj\n    obj_list[[sample]] <- obj\n\n}\n\n### There are 4,.75 GB\nlobstr::obj_size(obj_list)\n\n### Look at the cells and genes for each sample\ndo.call(rbind, lapply(obj_list, dim))\n\n### Save data for later exploration\nfs::dir_create(output_path)\n\nfor (sample in names(obj_list)) {\n\n    obj <- obj_list[[sample]]\n\n    ### Calculate mitotic/ribosomal percentage\n    obj <- PercentageFeatureSet(\n        obj, pattern = \"^MT-\", col.name = \"percent_mito\"\n    )\n\n    obj <- PercentageFeatureSet(\n        obj, pattern = \"^RP[LS]\", col.name = \"percent_ribo\"\n    )\n    \n    ### Save \n    saveRDS(\n        obj, here(output_path, paste0(sample, \".rds\")), \n        compress = \"xz\"\n    )\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n### Load data\noutput_path <- here(\"projects/2023_NC_BCexh/BCexh_scRNAseq/output\")\n\n# obj_list$TBB011[[]] |> head()\n\n### Inspect PCA\nplots <- list()\nfor (sample in names(obj_list)) {\n\n    plots[[sample]] <- ElbowPlot(object = obj_list[[sample]], ndim = 30) +\n        labs(title = sample) + \n        FontSize(x.text = 8, y.text = 8, x.title = 8, y.title = 8, main = 8)\n\n}\npatchwork::wrap_plots(plots[1:4], ncol = 2)\n\n# DimHeatmap(obj_list$TBB102, dims = 10:30, cells = 500, balanced = TRUE)\n# FeaturePlot(obj_list$TBB102, reduction = \"tsne\", features = \"nFeature_RNA\")\n# DimPlot(obj_list$TBB102, label = TRUE, group.by = \"RNA_snn_res.0.4\")\n# DimPlot(obj_list$TBB102, label = TRUE, reduction = \"tsne\")\n\n# obj_list$TBB011[[]] |> head()\n\n### Glimpse QC metrics\nVlnPlot(\n    obj_list$TBB011,\n    features = c(\"nFeature_RNA\", \"nCount_RNA\", \"percent_mito\"),\n    ncol = 1, pt.size = 0, sort = FALSE, log = TRUE\n)\n\n### Cell type\nFeaturePlot(\n    obj_list$TBB011, reduction = \"umap\", ncol = 2,\n    features = c(\"CD3E\", \"CD14\", \"PTPRC\", \"EPCAM\", \"PECAM1\", \"FAP\")\n)\n\n### Varify DoubletFinder\ntable(obj_list$TBB011$excl_doublet)\nUMAPPlot(\n    obj_list$TBB011, group.by = \"excl_doublet\",\n    # order = c(TRUE, FALSE),\n    cols = c(\"black\", \"red\")\n)\n\ntable(\n  obj_list$TBB011@meta.data$excl_doublet, \n  obj_list$TBB011@meta.data$RNA_snn_res.0.4\n)\n\nobj_list$TBB011[[]] |> head()\n### Sanity checks\nDimPlot(obj_list$TBB011, label = TRUE)\nDotPlot(obj_list$TBB011, features = c(\"CD3E\", \"CD14\", \"PTPRC\", \"EPCAM\"))\nFeaturePlot(obj_list$TBB011, features = c(\"CD3E\", \"CD14\", \"PTPRC\", \"EPCAM\"))\nFeaturePlot(obj_list$TBB011, features = c(\"FAP\", \"PECAM1\", \"PTPRC\", \"EPCAM\"))\nFeaturePlot(obj_list$TBB011, features = c(\"CD14\", \"CD3E\"))\nFeaturePlot(obj_list$TBB011, features = c(\"MKI67\"), split.by = \"excl_doublet\")\n```\n:::\n\n\n### Aggregate samples data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n### Clear environment\nrm(list = ls())\ngc()\n\n### Output directory\noutput_path <- here(\"projects/2023_NC_BCexh/BCexh_scRNAseq/output\")\n\n### Samples to load\nsample_list <- c(\n    ### IE1 \n        \"TBB011\",\n        \"TBB111\",\n        \"TBB129\",\n        \"TBB165\",\n        \"TBB171\",\n        \"TBB184\",\n        \"TBB338\",\n    \n    ### IE2\n        \"TBB035\",\n        \"TBB075\",\n        \"TBB102\",\n        \"TBB212\",\n        \"TBB214\",\n        \"TBB226\",\n        \"TBB330\"\n    )\n\n### Load IE1 vs IE2 samples for easier processing\nobj_list <- list()\nfor (sample in sample_list) {\n    ### Load data\n    obj <- readRDS(here(output_path, paste0(sample, \".rds\")))\n    \n    obj_list[[sample]] <- obj\n}\n\n### Merge objects\nmerged_pre_filter <- merge(\n    x = obj_list[[1]], y = obj_list[-1], add.cell.ids = names(obj_list)\n)\n### 4.75GB\nlobstr::obj_size(merged_pre_filter)\n\n### Remove for efficient memory\nrm(obj_list, obj)\n\n### Need to Join layers in Seurat V5\nmerged_pre_filter[[\"RNA\"]] <- JoinLayers(merged_pre_filter[[\"RNA\"]])\n\n### Excluding high-confidence doublets\ntable(merged_pre_filter$sample, merged_pre_filter$excl_doublet)\nmerged_pre_filter <- subset(merged_pre_filter, subset = excl_doublet == FALSE)\n\n### Save cell count data for each sample\ncells_per_sample <- table(merged_pre_filter@meta.data$sample)\nwrite.csv(\n    cells_per_sample, \n    here(output_path, \"CellsPerSample_preFilter.csv\"),\n    row.names = FALSE\n)\n\n### 4.26 GB\nlobstr::obj_size(merged_pre_filter)\n```\n:::\n\n\n### Inspect the quality metrics\n\n\n::: {.cell}\n\n```{.r .cell-code}\n### Load data\nmerged_pre_filter <- readRDS(here(output_path, \"merged_pre_filter.rds\"))\n\n### Vlnplot\nVlnPlot(\n    merged_pre_filter, \n    features = c(\"nFeature_RNA\", \"nCount_RNA\", \"percent_mito\"),\n    ncol = 1, pt.size = 0, sort = FALSE, log = TRUE\n)\n\n### Density plot\nplot(\n    density(merged_pre_filter@meta.data$percent_mito), \n    main = \"Mitochondrial Percentage Density Plot\", \n    xlab = \"Percent Mitochondrial Genes\"\n)\nplot(\n    density(merged_pre_filter@meta.data$nCount_RNA), \n    main = \"Total Reads\", \n    xlab = \"Total Reads per Cell\"\n)\nplot(\n    density(merged_pre_filter@meta.data$nFeature_RNA), \n    main = \"Number of detected genes\", \n    xlab = \"Deteced Genes per cell\"\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n### Filtering low quality cells\nmerged_post_filter <- subset(\n    merged_pre_filter,\n    subset = nFeature_RNA > 200 &\n        nFeature_RNA < 7500 &\n        percent_mito < 20 &\n        nCount_RNA < 75000\n)\n\n### Save cell count data for each sample post filtering\ncells_per_sample <- table(merged_post_filter@meta.data$sample)\nwrite.csv(\n    cells_per_sample, \n    here(output_path, \"CellsPerSample_postFilter.csv\"),\n    row.names = FALSE\n)\n\n### Save mean reads and median gene counts per cell for each sample\nmean_reads <- as_tibble(\n    merged_post_filter@meta.data[, c(\"sample\", \"nCount_RNA\", \"nFeature_RNA\")]\n) |> \ngroup_by(sample) |> \nsummarise(\n    mean_reads = mean(nCount_RNA), \n    median_genes = median(nFeature_RNA),\n    .groups = \"drop\"\n)\nwrite.csv(mean_reads, here(output_path, \"postfilter_stats.csv\"))\n\n### Save\nsaveRDS(\n    merged_post_filter, here(output_path, \"merged_post_filter.rds\"), \n    compress = \"xz\"\n)\n```\n:::\n\n\n### Run general workflow\n\n::: {.cell}\n\n```{.r .cell-code}\n### Maxmize memory usage\n# future::plan(\"multiprocess\", workers = 2)\n# options(future.globals.maxSize = 5* 1000 * 1024^2)\n\n### Load data\nmerged_post_filter <- readRDS(here(output_path, \"merged_post_filter.rds\"))\n\n### Option: Apply sctransform normalization: replaces FindVariableFeatures,\n### Normalize and ScaleData. For a start, don't regress out anything\n### Note! This step comsumes a lot memory\n# merged_post_filter <- SCTransform(merged_post_filter, verbose = TRUE)\n\n### Standard normalization\nmerged_post_filter <- NormalizeData(merged_post_filter)\nmerged_post_filter <- ScaleData(merged_post_filter)\nmerged_post_filter <- FindVariableFeatures(\n    merged_post_filter,\n    x.low.cutoff = 0.0125, y.cutoff = 0.25, do.plot = FALSE\n)\n\nmerged_post_filter <- RunPCA(\n    merged_post_filter,\n    features = VariableFeatures(merged_post_filter),\n    verbose = FALSE\n)\n\n### Find the resolution: Clustree analysis\n# clustree(merged_post_filter, prefix = \"RNA_snn_res.\", exprs = \"scale.data\")\n\n### Graph-based clustering\nmerged_post_filter <- FindNeighbors(merged_post_filter, dims = 1:27) \nmerged_post_filter <- FindClusters(merged_post_filter, resolution = 2)\nmerged_post_filter <- RunUMAP(merged_post_filter, dims = 1:27)\n\n### If the clusters are not ordered correctly:\n# cluster_order <- c(0:57)\n# merged_post_filter@active.ident <- factor(x = merged_post_filter@active.ident, levels = cluster_order)\n\n### Save object to easily load it back without re-running computationally\n### intensive steps above\nsaveRDS(\n    merged_post_filter,\n    here(output_path, \"merged_complete_umap.rds\"),\n    compress = \"xz\"\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n### Load processed data from output directory\noutput_path <- here(\"projects/2023_NC_BCexh/BCexh_scRNAseq/output\")\nmerged_post_filter <- readRDS(here(output_path, \"merged_complete_umap.rds\"))\n\n### Examine and visualize PCA results in a few different ways\nprint(\n    x = merged_post_filter[[\"pca\"]],\n    dims = 1:5, nfeatures = 5, projected = FALSE\n)\n\n### For easy exploration of the primary sources of heterogeneity in a dataset\n# DimHeatmap(merged_post_filter, dims = 1:6, cells = 500, balanced = TRUE)\n# VizDimLoadings(merged_post_filter, dims = 1:2)\nElbowPlot(merged_post_filter, ndim = 50)\n\n### Inspect cluster\np1 <- DimPlot(merged_post_filter, reduction = \"umap\", group.by = \"sample\") +\n    theme(legend.position = \"top\")\np2 <- DimPlot(merged_post_filter, reduction = \"umap\", group.by = \"cell_type\") +\n    theme(legend.position = \"top\")\np1 + p2 + plot_layout(nrow = 1)\n\n### Check some marker expression\nFeaturePlot(\n    merged_post_filter, reduction = \"umap\",\n    features = c(\"PECAM1\", \"EPCAM\", \"FAP\", \"PTPRC\", \"CD3E\", \"CD14\")\n)\n\n### Save number of clusters and cells per cluster post filtering\ncells_per_cluster <- table(merged_post_filter@meta.data$SCT_snn_res.2)\nwrite.csv(\n    cells_per_cluster, \n    here(outpath, \"dim27_res2_CellsPerCluster.csv\"), row.names = FALSE\n)\n\n### Save cluster proportions by sample\ncluster_sample <- table(\n    Idents(merged_post_filter), merged_post_filter$sample\n)\nwrite.csv(\n    cluster_sample, \n    here(output_path, \"cellnr_per_cluster_bySample.csv\"), \n    row.names = TRUE\n)\ncluster_sample_prop <- prop.table(\n    table(Idents(merged_post_filter), merged_post_filter$sample), \n    margin = 2\n)\nwrite.csv(\n    cluster_sample_prop, \n    here(output_path, \"cluster_samples_proportions.csv\"), \n    row.names = TRUE\n)\n```\n:::\n\n\n### Finding DEG for clusters\n\n\n::: {.cell}\n\n```{.r .cell-code}\nIdents(merged_post_filter) <- merged_post_filter$seurat_clusters\ncluster_markers_mast <- FindAllMarkers(\n    merged_post_filter,\n    test.use = \"MAST\",\n    only.pos = TRUE, min.pct = 0.25,\n    logfc.threshold = 0.25,\n)\nwrite.csv(\n    cluster_markers_mast,\n    here(output_path, \"DE_cluster_AllMarkerGenes_MAST.csv\"),\n    row.names = FALSE\n)\n\n### Top10 DEG for each cluster\nmarker_genes <- cluster_markers_mast |>\n    group_by(cluster) |>\n    slice_max(avg_log2FC, n = 10)\nwrite.csv(\n    marker_genes,\n    here(output_path, \"DE_cluster_MarkerGenesTop10.csv\"),\n    row.names = TRUE\n)\n```\n:::\n\n\n### Annotate cell types\n\n### Cell type frequencies\n\n\n::: {.cell}\n\n```{.r .cell-code}\n### Load processed scRNA data\nmerged_post_filter <- readRDS(here(output_path, \"merged_complete_umap.rds\"))\n\n### Extract group info\nsample_info <- merged_post_filter[[]] |>\n    select(sample, IE) |>\n    distinct()\n\n### Assign pDC or cDC to dendritic cell\n# merged_post_filter$cell_type[merged_post_filter$cell_type == \"pDC\"] <- \"dendritic cell\"\n\n### Reset active IDs to cell type\nIdents(merged_post_filter) <- \"cell_type\"\nlevels(Idents(merged_post_filter))\ntable(Idents(merged_post_filter))\n\n### Save cell number of cell type\ncelltype_sample <- table(\n    merged_post_filter$cell_type, merged_post_filter$sample\n)\nwrite.csv(\n    celltype_sample, here(output_path, \"celltype_samples.csv\"),\n    row.names = TRUE\n)\n\n### Save proportions of cell type for each sample\ncelltype_sample_prop <- prop.table(\n    table(merged_post_filter$cell_type, merged_post_filter$sample),\n    margin = 2\n)\nwrite.csv(\n    celltype_sample_prop,\n    here(output_path, \"celltype_samples_proportions.csv\"),\n    row.names = TRUE\n)\n\n### Ploty cell type frequencies using stacked barplot\ncelltype_sample_prop <- read.csv(\n    here(output_path, \"celltype_samples_proportions.csv\")\n) |>\n    pivot_longer(\n        starts_with(\"TB\"), names_to = \"sample\", values_to = \"percentage\"\n    ) |>\n    dplyr::rename(cell_type = X) |>\n    ### Factor cell type\n    mutate(\n        cell_type = factor(\n            cell_type,\n            levels = c(\n                \"T/NK cell\", \"myeloid\", \"B cell\", \"granulocyte\",\n                \"dendritic cell\", # \"cDC\", \"pDC\",\n                \"plasma cell\", \"epithelial\", \"fibroblast\", \"endothelial\"\n            )\n        )\n    ) |>\n    left_join(sample_info, by = \"sample\")\n\n### Plot\ncelltype_sample_prop |>\n    as_tibble() |>\n    ggplot(aes(x = sample, y = percentage, fill = cell_type)) +\n    geom_bar(stat = \"identity\") +\n    theme(\n        axis.title.x = element_blank(),\n        axis.title.y = element_blank(),\n        panel.background = element_blank(),\n        axis.text.x = element_text(angle = 30)\n    ) +\n    # coord_flip()+\n    ggtitle(\"Sample composition by cell type\")\n\n### Cell type proportions by IE1 vs IE2\nstat_res <- celltype_sample_prop |>\n    group_by(cell_type) |>\n    wilcox_test(percentage ~ IE) |>\n    add_significance() |>\n    add_xy_position(x = \"cell_type\")\n\nggplot(celltype_sample_prop, aes(x = IE, y = percentage, fill = IE)) +\n    geom_boxplot() +\n    geom_point() +\n    facet_wrap(~ cell_type, scales = \"free\", ncol = 5, strip.position = \"bottom\") +\n    theme(\n        axis.ticks.x = element_blank(),\n        axis.text.x = element_blank(),\n        axis.title.x = element_blank()\n    ) +\n    # theme(panel.background = element_blank())+\n    ylab(\"proportion\")\n    # stat_pvalue_manual(stat_res, hide.ns = TRUE)\n```\n:::\n\n\n### Cytof vs 10x Cell type\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Cytof cell type percentages\ncytof_dir <- here(\"projects/2023_NC_BCexh/BCexh_scRNAseq/03_Additional_files\")\ncytof_perc <- read.csv(\n    here(cytof_dir, \"cytof_celltype_prop.csv\")\n) |>\n    pivot_longer(\n        starts_with(\"TBB\"), names_to = \"sample\", values_to = \"percentage\"\n    ) |>\n    rename(cell_type = cell_type) |>\n    left_join(sample_info, by = \"sample\") |>\n    mutate(method = \"cytof\")\n\nggplot(cytof_perc, aes(sample, y = percentage, fill = cell_type)) +\n    geom_bar(stat = \"identity\") +\n    theme(axis.title.x = element_blank(), axis.title.y = element_blank()) +\n    # coord_flip()+\n    theme(panel.background = element_blank()) +\n    ggtitle(\"CyTOF percentages\")\n\n### Adapt 10x celltypes to fit CyTOF celltypes\n# merged_post_filter$cell_type <- factor(\n#     merged_post_filter$cell_type,\n#     levels = c(\n#         \"T/NK cell\",\n#         \"myeloid\",\n#         \"B cell\",\n#         \"dendritic cell\",\n#         \"granulocyte\",\n#         \"plasma cell\",\n#         \"epithelial\",\n#         \"endothelial\",\n#         \"fibroblast\"\n#         # \"cDC\",\n#         # \"pDC\"\n#     )\n# )\ncelltype_sample_prop |>\n    ggplot(aes(sample, y = percentage, fill = cell_type)) +\n    geom_bar(stat = \"identity\") +\n    theme(axis.title.x = element_blank(), axis.title.y = element_blank()) +\n    # coord_flip()+\n    theme(panel.background = element_blank()) +\n    ggtitle(\"10x percentages\")\n\n### Combine cytof and 10x percentages\ncelltype_pct <- bind_rows(\n    cytof_perc,\n    celltype_sample_prop |> mutate(method = \"10x\")\n)\n\ncelltype_pct$cell_type <- factor(\n    celltype_pct$cell_type,\n    levels = c(\n        \"T/NK cell\", \"myeloid\", \"B cell\", \"dendritic cell\", \"granulocyte\",\n        \"plasma cell\", \"epithelial\", \"endothelial\", \"fibroblast\", \"other\"\n    )\n)\n\ncelltype_pct$method <- factor(celltype_pct$method, levels = c(\"cytof\", \"10x\"))\ncelltype_pct <- celltype_pct |> drop_na()\n\nggplot(celltype_pct, aes(method, y = percentage, fill = cell_type)) +\n    geom_bar(stat = \"identity\") +\n    facet_wrap(~sample, ncol = 6) +\n    theme(\n        axis.title.x = element_blank(),\n        axis.title.y = element_blank(),\n        panel.background = element_blank()\n    ) +\n    # coord_flip()+\n    ggtitle('Celltype percentages: CyTOF vs. scRNA-seq')\n```\n:::\n\n\n### Inspect some chemokine features\n\n\n::: {.cell}\n\n```{.r .cell-code}\nCCLs <- paste0(\"CCL\", c(1:28))\nCX_XCs <- c(paste0(\"CXCL\", c(1:17)), \"CXCL4L1\", \"XCL1\", \"XCL2\", \"CX3CL1\")\nILs  <- paste0(\"IL\", c(1:33))\nother_cytokines <- c(\n    \"TNF\", \"IFNG\", \"IFNA1\", \"IFNB1\", \"TGFB1\", \"CSF1\", \"CSF2\", \"CSF3\", \"EPO\"\n)\ninteraction_other <- c(\n    \"CD47\", \"SIRPG\", \"SIRPA\", \"FASLG\", \"FAS\", \"CD80\", \"CD86\", \"CTLA4\"\n)\ncytokine_receptor <- c(\n    'CCR1', 'CCR2', 'CCR3', 'CCR4', 'CCR5', 'CCR6', 'CCR7', 'CCR8', 'CCR9', \n    'CCR10', 'CCR11', 'IL10RA', 'IL4R', 'CXCR1', 'CXCR2', 'CXCR3', 'CXCR4', \n    'CXCR5', 'CXCR6', 'CXCR7'\n)\n\n# example_data <- readRDS(here(output_path, \"\"))\nVlnPlot(\n    merged_post_filter, features = c(\"nFeature_RNA\"), pt.size = 0\n) + \nNoLegend()\n# theme(legend.position = \"right\") +\n# guides(fill = guide_legend(ncol = 2))\n\nDotPlot(merged_post_filter, features = c(\"PTPRC\", \"CD3E\", \"CD14\", \"CD68\"))\nFeaturePlot(merged_post_filter, features = c(\"nFeature_RNA\", \"nCount_RNA\"))\n```\n:::\n\n\n### Chemkine expression per cell type\n\n::: {.cell}\n\n```{.r .cell-code}\nchemokines <- c(\n    \"CXCL9\", \"CXCL10\", \"CXCL13\", \"CCL4\", \"CCL5\", \"CCL3\", \"CXCL8\",\n    \"CCL17\", \"CCL22\"\n)\n\nchemokine_tab <- data.frame(celltype = merged_post_filter$cell_type)\n\n### Seurat V5, the counts data do not have colnames and rownames\ncounts <- merged_post_filter@assays$RNA@layers$counts\nrownames(counts) <- Features(merged_post_filter)\ncolnames(counts) <- Cells(merged_post_filter)\n\nfor (i in chemokines) {\n    chemokine_tab[, i] <- ifelse(counts[i, ] > 0, 1, 0)\n}\n\nchemokine_add  <-  data.frame(celltype = unique(chemokine_tab$celltype))\n\nfor (i in chemokines) {\n    count_i <- as.data.frame(\n        table(chemokine_tab$celltype, chemokine_tab[, i])[, \"1\"]\n    )\n    colnames(count_i) <- i\n    count_i$celltype <- rownames(count_i)\n    chemokine_add <- merge(chemokine_add, count_i, by = \"celltype\")\n}\n```\n:::\n\n### Save immune subsets\n\n\n::: {.cell}\n\n```{.r .cell-code}\n### Load data\nmerged_post_filter <- readRDS(here(output_path, \"merged_complete_umap.rds\"))\n\n### Immune subset\nimmune <- subset(\n    merged_post_filter,\n    idents = c(\n        \"T/NK cell\", \n        \"myeloid\", \n        \"B cell\", \n        \"granulocyte\", \n        # \"dendritic cell\",\n        # \"cDC\",\n        \"pDC\", \n        \"plasma cell\"\n    )\n)\nsaveRDS(immune, here(output_path, \"immune.rds\"), compress = \"xz\")\nrm(immune)\n\n## T/NK cell subset\nTNK <- subset(merged_post_filter, idents = \"T/NK cell\")\nsaveRDS(\n    TNK,\n    here(output_path, \"T_NK_cells.rds\"),\n    compress = \"xz\"\n)\nrm(TNK)\n\n### Myeloid subset (incl. DCs)\nmyeloid <- subset(\n    merged_post_filter, idents = c(\n        \"myeloid\", \n        \"dendritic cell\"\n        # \"cDC\", \n        # \"pDC\"\n    )\n)\nsaveRDS(myeloid, here(output_path, \"myeloid_inclDC.rds\"), compress = \"xz\")\nrm(myeloid)\n\n### B cell subset\nB <- subset(merged_post_filter, idents = \"B cell\")\nsaveRDS(B, here(output_path, \"B_cells.rds\"))\nrm(B)\n\n### Plasma cell subset\nPC <- subset(x = merged_post_filter, idents = \"plasma cell\")\nsaveRDS(PC, here(output_path, \"plasma_cells.rds\"))\nrm(PC)\n\n### Granulocyte subset\ngran <- subset(x = merged_post_filter, idents = \"granulocyte\")\nsaveRDS(gran, here(output_path, \"granulocytes.rds\"))\nrm(gran)\n\n### tumor cell subset\nep <- subset(x = merged_post_filter, idents = \"epithelial\")\nsaveRDS(ep, here(output_path, \"epithelial.rds\"))\nrm(ep)\n\n### fibroblast subset\nfib <- subset(x = merged_post_filter, idents = \"fibroblast\")\nsaveRDS(fib, here(output_path, \"fibroblast.rds\"))\nrm(fib)\n\n### endothelial cell subset\nendo <- subset(x = merged_post_filter, idents = \"endothelial\")\nsaveRDS(endo, here(output_path, \"endothelial.rds\"))\nrm(endo)\n```\n:::\n\n\n## T cells subclustering\n\n### Process T cells subset\n\n\n::: {.cell}\n\n```{.r .cell-code}\n### Load T cells subset\npath <- here(\"projects/2023_NC_BCexh/BCexh_scRNAseq/output\")\nrun1_Tcell <- readRDS(here(path, \"T_NK_cells.rds\"))\n### 6,77GB is too big for running\nlobstr::obj_size(run1_Tcell)\n\n### Use subset data example\nTcell <- subset(\n    run1_Tcell, \n    subset = sample == c(\n        \"TBB011\", \"TBB165\", \"TBB338\", \"TBB075\", \"TBB330\", \"TBB214\")\n    )\nlobstr::obj_size(Tcell)\nrm(run1_Tcell)\n\n### Store Keratin and MGP percentage in object meta data\nTcells <- PercentageFeatureSet(\n    Tcells, pattern = \"^KRT\", col.name = \"percent_krt\"\n)\nTcells <- PercentageFeatureSet(\n    Tcells, pattern = \"MGP\", col.name = \"percent_MGP\"\n)\ncolnames(Tcells[[]])\n\n### Run Normalization, ScaleData, and FindVariableFeatures\nTcells <- SCTransform(\n    Tcells,\n    vars.to.regress = c(\"percent_mito\", \"percent_krt\", \"percent_MGP\"),\n    verbose = TRUE\n)\n\n### Dimensional reduction\nTcells <- RunPCA(Tcells, verbose = FALSE)\nTcells <- RunUMAP(Tcells, dims = 1:15)\nTcells <-  FindNeighbors(Tcells, dims = 1:15)\nTcells <- FindClusters(Tcells, resolution = 1)\n\n### Save object\nsaveRDS(\n    Tcells, here(path, \"Tcells.rds\"),\n    compress = \"xz\"\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n### Load T cells subset\npath <- here(\"projects/2023_NC_BCexh/BCexh_scRNAseq/output\")\nTcells <- readRDS(here(path, \"Tcells.rds\"))\ncolnames(Tcells[[]])\n\nElbowPlot(Tcell, ndims = 25)\n# VizDimLoadings(Tcell, dims = 1:2)\n# PCAPlot(Tcell)\n# DimHeatmap(Tcell, dims = 15:20, cells = 500, balanced = TRUE)\nDimPlot(Tcell, reduction = \"umap\", label = TRUE)\nDimPlot(Tcell, reduction = \"umap\", group.by = \"sample\")\nDimPlot(Tcell, reduction = \"umap\", group.by = \"sample\")\n\n### Clustree analysis\n# clustree(Tcell, prefix = \"SCT_snn_res.\") +\n#     scale_edge_color_continuous(low = \"black\", high = \"black\")\n\n### QC plots\nVlnPlot(\n    Tcell,\n    features = c(\"nFeature_RNA\", \"nCount_RNA\", \"percent_mito\"),\n    ncol = 1, pt.size = 0, sort = FALSE\n)\nVlnPlot(\n    Tcell,\n    features = c(\"percent_krt\", \"percent_MGP\"),\n    pt.size = 0, sort = FALSE, ncol = 1\n)\n\nDimPlot(Tcell, group.by = \"Tcell_cluster\")\nDimPlot(Tcell, group.by = \"Tcell_metacluster\")\nDimPlot(Tcell, group.by = \"SCT_snn_res.1\")\nFeaturePlot(Tcell, features = c(\"PDCD1\", \"CD4\", \"CD8A\", \"FOXP3\"))\nVlnPlot(Tcell, features = c(\"MKI67\"), pt.size = 0, sort = FALSE)\n\n### Highlight individual clusters\nIdents(Tcell) <- Tcell$Tcell_metacluster\ncells_CD4ex <- WhichCells(\n    Tcell, ident = c(\"CD4_exhausted\", \"CD8_exhausted\")\n)\nDimPlot(Tcell, reduction = \"umap\", cells.highlight = cells_CD4ex)\n```\n:::\n\n### Cluster proportions\n\n::: {.cell}\n\n```{.r .cell-code}\n### Load processed data\nTcell_dir <- here(\"projects/2023_NC_BCexh/BCexh_scRNAseq/output/Tcells\")\nfs::dir_create(Tcell_dir)\n\n### Extract group info\nsample_info <- Tcells[[]] |>\n    select(sample, IE) |>\n    distinct()\n\n### Which cluster is each sample made of? (by cluster)\ncluster_samples_count <- table(Tcells$SCT_snn_res.1, Tcells$sample) |>\n    as.data.frame() |>\n    as_tibble() |>\n    dplyr::rename(cluster = Var1, sample = Var2, prop = Freq)\n# write.csv(\n#     cluster_samples_count,\n#     here(Tcell_dir, \"cluster_samples_count.csv\"),\n#     row.names = TRUE\n# )\nggplot(cluster_samples_count, aes(sample, y = prop, fill = cluster)) +\n    geom_bar(stat = \"identity\") +\n    theme(axis.title.x = element_blank(), axis.title.y = element_blank()) +\n    coord_flip() +\n    theme(panel.background = element_blank()) +\n    ggtitle(\"Sample composition (T/NK clusters)\")\n\n\n### How many cells of each sample in each cluster? (by sample)\ncluster_samples_prop <- prop.table(\n    table(Tcells$SCT_snn_res.1, Tcells$sample),\n    margin = 1\n) |>\n    as.data.frame() |>\n    as_tibble() |>\n    dplyr::rename(cluster = Var1, sample = Var2, prop = Freq)\n# write.csv(\n#     cluster_samples_prop,\n#     here(Tcell_dir, \"cluster_samples_proportion.csv\"),\n#     row.names = TRUE\n# )\nggplot(cluster_samples_prop, aes(cluster, y = prop, fill = sample)) +\n    geom_bar(stat = \"identity\") +\n    theme(\n        axis.title.x = element_blank(),\n        axis.title.y = element_blank(),\n        panel.background = element_blank()\n    ) +\n    # coord_flip()+\n    ggtitle(\"T/NK cell cluster composition\")\n\n### How many cells of each IE are in each cluster\ncluster_IE_count <- table(Tcells$SCT_snn_res.1, Tcells$IE) |> \n    as.data.frame() |>\n    as_tibble() |>\n    dplyr::rename(cluster = Var1, IE = Var2, count = Freq)\nggplot(cluster_IE_count, aes(cluster, y = count, fill=IE)) +\n  geom_bar(stat=\"identity\")+\n  theme(axis.title.x=element_blank(), axis.title.y = element_blank())+\n  #coord_flip()+\n  theme(panel.background = element_blank())+\n  ggtitle(\"T/NK cell cluster composition\")\n\n### What percentage of each IE is in which cluster?\ncluster_IE_prop <- prop.table(\n    table(Tcells$SCT_snn_res.1, Tcells$IE),\n    margin = 1\n) |>\n    as.data.frame() |>\n    as_tibble() |>\n    dplyr::rename(cluster = Var1, IE = Var2, prop = Freq)\nggplot(cluster_IE_prop, aes(cluster, y = prop, fill = IE)) +\n    geom_bar(stat = \"identity\", position = \"dodge\") +\n    theme(axis.title.x = element_blank(), axis.title.y = element_blank()) +\n    # coord_flip()+\n    theme(panel.background = element_blank()) +\n    ggtitle(\"Proportion of each TIG belonging to a specific cluster\")\n\nggplot(cluster_IE_prop, aes(x = IE, y = prop, fill = IE)) +\n    geom_boxplot() +\n    geom_point() +\n    facet_wrap(\n        ~ cluster, scales = \"free\", \n        ncol = 3, \n        strip.position = \"bottom\"\n    ) +\n    theme(\n        axis.title.x = element_text(\"cluster\"),\n        axis.text.x = element_blank(),\n        axis.ticks.x = element_blank()\n    ) +\n    # theme(panel.background = element_blank())+\n    xlab(\"cluster\")\n```\n:::\n\n\n### Finding cluster DEG\n\n\n::: {.cell}\n\n```{.r .cell-code}\nIdents(Tcells) <- Tcells$SCT_snn_res.1\nTcells_markers <- FindAllMarkers(\n    Tcells, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25\n)\nmarker_genes_top10 <- Tcells_markers |>  \n    group_by(cluster) |> \n    slice_max(avg_log2FC, n = 10)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n### Feature list\nfeatures <- c(\"FOXP3\", \"CCL18\", \"IL2RA\")\nfeatures_cytof <- c(\n    'CD3E', 'CD8A', 'CD4', 'FOXP3', 'HAVCR2', 'PDCD1', 'CTLA4', 'ICOS', \n    'IL2RA', 'PTPRC', 'CD68', 'CD14', 'CD274', 'CCR7', 'HLA-DRA', 'MRC1', \n    'SIGLEC1', 'MSR1', 'CD163', 'FCGR2A', 'FCGR2B', 'FCGR2C', 'FCGR1A', \n    'ITGAM', 'ITGAX', 'FCGR3A', 'CD93', 'IL3RA', 'CD86', 'CD36', 'CD38', \n    'CCR2', 'SLAMF7'\n)\nfeatures_cytof_T_01 <- c('CD3E', 'CD8A', 'FOXP3', 'HAVCR2', 'PDCD1', 'CTLA4')\nfeatures_cytof_T_02 <- c('ICOS', 'IL2RA', 'PTPRC', 'CD4', 'CCR7', 'CD38')\nfeatures_cytof_T <- c(\n    'CD3E', 'CD8A', 'FOXP3', 'HAVCR2', 'PDCD1', 'CTLA4', 'ICOS', 'IL2RA', \n    'PTPRC', 'CD4', 'CCR7', 'CD38', 'NCAM1'\n)\nfeatures_T_extended <- c(\n    'CD3E', 'CD8A', 'FOXP3', 'HAVCR2', 'PDCD1', 'CTLA4', 'ICOS', 'IL2RA', \n    'PTPRC', 'CD4', 'CCR7', 'CD38', 'NCAM1', 'ENTPD1', 'ITGAE', 'SELL', \n    'CD40LG', \"FCGR3A\", \"CD27\", \"IL7R\", \"HLA-DRA\", \"TBX21\", \"CD69\", \"NCR1\", \n    \"IRF4\"\n)\ncytokine <- c(\n    'CCL20', 'CCL22', 'CXCL2', 'CXCL3', 'CXCL8', 'CCL8', 'CCL18', 'CCL2', \n    'CCL3', 'CCL4', 'CCL4L2', 'CCL5', 'CXCL10', 'CXCL12', 'CCL13', 'CXCL1', \n    'CXCL13', \"IL4\", \"IL13\", \"IFNG\", \"TNF\"\n)\nchemokine_01 <- c('CCL20', 'CCL22', 'CXCL2', 'CXCL3', 'CXCL8')\nchemokine_02 <- c('CCL8', 'CCL18', 'CCL2', 'CCL3', 'CCL4')\nchemokine_03 <- c('CCL4L2', 'CXCL10', 'CXCL12', 'CCL13', 'CXCL1')\ncytokine_receptor <- c(\n    'CCR1', 'CCR10', 'CCR2', 'CCR7', 'CCR4', 'CCR5', 'CCR6', 'IL10RA', \n    'IL4R', 'CXCR2', 'CXCR3', 'CXCR4', 'CXCR5', 'CCR8'\n)\nTF <- c(\n    'IRF2', 'IRF5', 'IRF8', 'IRF9', 'IRF4', 'IRF7', 'STAT1', 'STAT2', 'STAT4', \n    'TCF12', 'TCF19', 'BCL6', 'ZBTB31', 'ZBTB33', 'ZBTB47', 'CIITA'\n)\nfeatures_plitas <- c(\n    'CCR8', 'CCR10', 'CX3CR1', 'IL1RL1', 'IL2RA', 'IL1R2', 'TNFRSF8', \n    'TNFRSF4', 'TNFRSF9', 'TNFRSF18', 'CD177', 'CARD16'\n)\nTh1 <- c(\n    'CCL4', 'CD38', 'CXCL9', 'CXCL10', 'CXCL11', 'FN1', 'GNLY', 'GZMA', \n    'GZMB', 'IFNA', 'IFNG', 'IL2', 'IL8', 'IL10', 'IL12B', 'IL18', 'LTA', \n    'MAP3K8', 'OSM', 'STAT1', 'STAT4', 'TBX21', 'TIA1', 'TNF'\n)\nTh2 <- c(\n    'GATA3', 'IL4', 'IL5', 'IL10', 'IL13', 'MAF', 'STAT5A', 'STAT5B', 'STAT6'\n)\n\nTh17 <- c(\n    'BATF', 'CCL20', 'IL1A', 'IL1B', 'IL6', 'IL17A', 'IL17F', 'IL18', 'IL21', \n    'IL22', 'LTA', 'RORC', 'STAT3', 'TGFB1', 'TGFB2', 'TGFB3'\n)\ntumor_reactive <- c(\n    \"PDCD1\", \"LAG3\", \"HAVCR2\", \"TNFRSF9\", \"TNFRSF18\", \"ENTPD1\", \"ITGAE\", \n    \"CXCL13\", \"IRF4\", \"BATF\"\n)\ncytotoxic <- c(\n    \"GZMB\", \"GZMA\", \"GZMK\", \"TNF\", \"IFNG\", \"GNLY\", \"FASLG\", \"IL2\"\n)\nM1M2_rec <- c(\n    \"IL10RA\", \"IL10RB\", \"CXCR3\", \"CCR4\", \"CCR1\", \"CCR5\", \"IGF2R\", \"TFGBR2\", \n    \"TGFBR1\", \"TGFBR3\", \"ITGAV\", \"ITGA5\", \"LRP8\", \"LRP1\", \"SCARB1\", \"C3AR1\"\n)\nM1M2_lig <- c(\n    \"CALM1\", \"CALM2\", \"CALM3\", \"TGFB1\", \"TLN1\", \"HSP90AA1\", \"VEGFA\", \"GNAI2\", \n    \"PGF\", \"MDK\", \"FGF2\"\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nDimPlot(Tcells, reduction = \"umap\", group.by = \"Tcell_metacluster\")\nDimPlot(Tcells, reduction = \"umap\", group.by = \"Tcell_cluster\")\nDimPlot(Tcells, reduction = \"umap\", group.by = \"cell_type\")\n```\n:::\n\n\n### Correlation matrix\n\n\n::: {.cell}\n\n```{.r .cell-code}\nIdents(Tcells) <- Tcells$SCT_snn_res.1\ncluster_perc <- prop.table(table(Idents(Tcells), Tcells$sample), margin = 2)\ncluster_perc <- t(cluster_perc)\ncorr <- cor(cluster_perc)\n\n### For metaclusters\nT_mcluster_perc <- prop.table(\n    table(Tcells$Tcell_metacluster, Tcells$sample), margin = 2\n)\nT_mcluster_perc <- t(T_mcluster_perc)\n\n### Plot\ncorrplot(\n    corr, method = \"color\", type = \"upper\", tl.srt = 0, tl.offset = 1,\n    tl.cex = 1, tl.col = \"black\", title = \"Tcell cluster correlations\"\n)\n\n# compute p-values\np_corr <- cor.mtest(corr, method = \"pearson\")\np_corr2 <- p_corr[[1]]\n\n\n### Plot with p-values below zero in white\ncorrplot(\n    corr, method = \"color\", type = \"upper\", tl.srt = 0, tl.col = \"black\", tl.offset = 1, p.mat = p_corr2, \n    sig.level = 0.005, insig = \"label_sig\", \n    pch = \"*\", pch.cex = 1, title = \"Tcell cluster correlations (P<0.05)\"\n)\n```\n:::\n\n\n### CD4/CD8 ratio\n\n::: {.cell}\n\n```{.r .cell-code}\n# Idents(Tcells) <- Tcells$Tcell_metacluster\n# levels(Idents(Tcells))\n# T_only <- subset(\n#     Tcells, idents = c(\"NKT\", \"NK_activated\", \"NK\", \"proliferating\"), \n#     invert = TRUE\n# )\n\n# cluster_averages <- AverageExpression(T_only, return.seurat = TRUE)\n# dim(cluster_averages)\n# dim(cluster_averages_df)\n# rownames(cluster_averages_df) <- rownames(cluster_averages)\n# cluster_averages_df <- as.data.frame(cluster_averages@assays$RNA@layers$counts)\n# colnames(cluster_averages_df)\n# colnames(cluster_averages)\n\n# CD8_CD4_df <- as.data.frame(\n#     t(cluster_averages_df[c(\"CD8A\", \"CD8B\", \"CD4\"), ])\n# )\n# CD8_CD4_df$cluster <- rownames(CD8.CD4.df)\n# CD8.CD4.df <- mutate(CD8.CD4.df, ratio = (CD8A + CD8B) / 2 / CD4)\n\n# p <- ggplot(CD8.CD4.df, aes(cluster, ratio)) +\n#     geom_point() +\n#     ylab(\"CD8/CD4 ratio\") +\n#     theme(panel.background = element_blank(),\n#         panel.border = element_rect(color = \"black\", fill = NA, size = 1))\n```\n:::\n\n\n## T cells EdgeR pseudobulk\n\n\n::: {.cell}\n\n```{.r .cell-code}\n### Cluster-indepenent IE comparsion\nsamples <- c(\"TBB011\", \"TBB165\", \"TBB338\", \"TBB075\", \"TBB214\", \"TBB330\")\nraw_counts <- as.data.frame(Tcells@assays$RNA@layers$counts)\ndim(raw_counts)\nAssays(Tcells)\ncolnames(raw_counts) <- colnames(Tcells)\nrownames(raw_counts) <- rownames(Tcells[[\"RNA\"]])\n\n### Get the counts matrix\nraw_counts$TBB011 <- rowSums(raw_counts[,grep(\"TBB011\", names(raw_counts))])\nraw_counts$TBB165 <- rowSums(raw_counts[,grep(\"TBB165\", names(raw_counts))])\nraw_counts$TBB338 <- rowSums(raw_counts[,grep(\"TBB338\", names(raw_counts))])\nraw_counts$TBB075 <- rowSums(raw_counts[,grep(\"TBB075\", names(raw_counts))])\nraw_counts$TBB330 <- rowSums(raw_counts[,grep(\"TBB330\", names(raw_counts))])\nraw_counts$TBB214 <- rowSums(raw_counts[,grep(\"TBB214\", names(raw_counts))])\n\nraw_sums <- raw_counts[, samples]\nwrite.csv(raw_sums, here(Tcell_dir, \"sample_sum_counts.csv\"), row.names = TRUE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n### Load count data\nscrna_dir <- here(\"projects/2023_NC_BCexh/BCexh_scRNAseq\")\ncounts <- read.csv(here(Tcell_dir, \"sample_sum_counts.csv\"), row.names = \"X\")\ncolnames(counts)\n\n### Get group information\nclinical_data <- read_csv(\n    here(scrna_dir, \"03_Additional_files/clinical_data.csv\"),\n    show_col_types = FALSE\n) |> mutate(sample = str_glue(\"T{Patient_ID}\")) |>\n    dplyr::filter(sample %in% samples) |>\n    relocate(sample, IE, .before = Patient_ID) |>\n    arrange(IE)\n\n### Preapre a DGElist object\nobj <- edgeR::DGEList(\n    counts = counts, group = clinical_data$IE, samples = clinical_data\n)\n\n### Filter out lowly expressed genes\nkeep <- edgeR::filterByExpr(\n    obj, group = clinical_data$IE,\n    min.count = 30, min.total.count = 300, large.n = 4, min.prop = 0.6\n)\ntable(keep)\nobj <- obj[keep, , keep.lib.sizes = FALSE]\n\n### Normalisation for RNA composition using TMM (trimmed mean of M-values)\nobj <- edgeR::calcNormFactors(obj)\nobj$samples\n\n### Setup the design matrix\nsample <- factor(clinical_data$sample)\nIE <- factor(clinical_data$IE)\nIE <- relevel(IE, \"IE2\")\ndesign <- model.matrix(~IE)\n\n### Estimate dispersion (estimates common dispersion, trended dispersions and\n### tagwise dispersions in one run)\nobj <- estimateDisp(obj, design)\nplotBCV(obj)\n\n### Calcualte differential expression\n### exact test (only for single-factor experiments)\net <- exactTest(obj)\ntopTags(et)\n\n### Number of up/downregulated genes at 5% FDR\nsummary(decideTests(et))\nplotMD(et)\nabline(h=c(-1,1), col =\"blue\")\n\n### Export results\nwrite.csv(\n    as.data.frame(topTags(et, n=Inf)), \n    here(Tcell_dir, \"IE1vsIE2_EdgeR_samplesums_exactT_filtered.csv\")\n)\n```\n:::\n\n\n## Figure1\n\n### UMAP plots\n\n::: {.cell}\n\n```{.r .cell-code}\npath <- here(\"projects/2023_NC_BCexh/BCexh_scRNAseq\")\nall_merged <- readRDS(here(path, \"output/merged_complete_umap.rds\"))\ncolnames(all_merged[[]])\n\n### Color palette\ncolors <- hue_pal()(50)\nshow_col(colors)\n\n### Classify pDCs as myeloid cells for this large overview\nunique(all_merged[[]]$cell_type)\nall_merged$cell_type <- factor(all_merged$cell_type)\nct_levels <- levels(all_merged$cell_type)\nct_levels[6] <- \"mast cell/basophil\"\nlevels(all_merged$cell_type) <- ct_levels\n\n### Reorder patient levels\nall_merged$sample <- factor(all_merged$sample)\n\n### Subset to very few cells to get small pdfs\ncells <- WhichCells(all_merged)\ncells_sub <- sample(cells, 100)\nobject <- subset(all_merged, cells = cells_sub)\n\n### Color by celltype\numap_celltype <- DimPlot(\n    object, group.by = \"cell_type\",\n    cols = c(\n        \"#FF5F50\", \"darkorange2\", \"gold3\", \"#77C900\", \"#00AA5C\", \"#00C0BD\", \"#1F99FF\", \"#0044DB\", \"gray\")\n) +\n    theme_void()\n\n### Color by sample\numap_patient <- DimPlot(object, group.by = \"sample\") +\n    theme_void()\n\numap_celltype +  umap_patient\n\n### Color by sample group\numap_IE <- DimPlot(object, group.by = \"IE\") + \n    theme_void()\n\n### Color by clusters\nDimPlot(all_merged, group.by = \"RNA_snn_res.2\", label = TRUE) +\n    theme_void()\n```\n:::\n\n### Highlight fibroblast\n\n\n::: {.cell}\n\n```{.r .cell-code}\nIdents(all_merged) <- all_merged$cell_type\nfibroblasts  <-  WhichCells(object = all_merged, ident = c(\"fibroblast\"))\nDimPlot(\n    all_merged, reduction = \"umap\", cells.highlight = fibroblasts, \n    cols.highlight = \"#00C1AA\", sizes.highlight = 0.7, pt.size = 0.7\n)\n```\n:::\n\n### Feature plots\n\n\n::: {.cell}\n\n```{.r .cell-code}\n### save as png (Inkscape/Illustrator cannot handle UMAPs with lots of cells)\ngenes <- c(\"PTPRC\", \"PDGFRB\", \"CD3E\", \"CD14\", \"EPCAM\", \"PECAM1\")\nFeaturePlot(all_merged, genes, max.cutoff = 3) + theme_void()\n\n### save one plot as pdf to get vectorized legend (with very few cells)\ncells <- WhichCells(all_merged)\ncells_sub <- sample(cells, 1000)\nobj_sub <- subset(all_merged, cells = cells_sub)\nFeaturePlot(obj_sub, \"HLA-DRA\", max.cutoff = 3)\n```\n:::\n\n### Dotplots for lineage markers\n\n\n::: {.cell}\n\n```{.r .cell-code}\n### Features\ngenes <- c(\n    \"EPCAM\", \"CDH1\", \"PECAM1\", \"CAV1\", \"VWF\", \"PDGFRB\", \"FAP\", \"PTPRC\", \"CD3E\", \"NCAM1\", \"CD14\", \"HLA-DRA\", \"ITGAX\", \"MS4A1\", \"MS4A2\", \"IGKC\"\n)\ngenes_PDL1 <- c(\"CD274\", \"LAMP3\", \"CCR7\")\n\n### Main cell types only\nIdents(all_merged) <- all_merged$cell_type\nDotPlot(all_merged, features = genes_PDL1) +\n    coord_flip() +\n    theme(\n        axis.text.x = element_text(angle = 90, hjust = 1),\n        axis.title.x = element_blank(),\n        axis.title.y = element_blank()\n    )\n\n### all clusters\nIdents(all_merged) <- all_merged$RNA_snn_res.2\nDotPlot(all_merged, features = genes_PDL1) +\n    coord_flip() +\n    theme(\n        axis.text.x = element_text(angle = 90, hjust = 1),\n        axis.title.x = element_blank(),\n        axis.title.y = element_blank()\n    )\n```\n:::\n\n\n### Gene expression heatmap\n\n\n::: {.cell}\n\n```{.r .cell-code}\nIdents(all_merged) <- all_merged$cell_type\ncluster_averages_table <- AverageExpression(\n    all_merged, return.seurat = FALSE, assays = \"RNA\"\n)\n\nRNA_average <- as.matrix(cluster_averages_table[[1]])\n\n### Normalize between 0 and 1\nRNA_average_norm <- apply(\n    RNA_average, 1, function(x) (x - min(x)) / (max(x) - min(x))\n)\nRNA_average_znorm <- apply(RNA_average, 1, function(x) (x - mean(x)) / sd(x))\n\nT_supp <- c(\n    \"CD274\", \"PDCD1LG2\", \"IDO1\", \"CD80\", \"CD86\", \"CCL17\", \"CCL19\", \"CCL22\", \"IL15\"\n)\n\nHeatmap(\n    t(subset(RNA_average_norm, select = T_supp)),\n    show_row_names = TRUE,\n    row_dend_side = \"left\",\n    heatmap_legend_param = list(title = \"Normalized\\nmean counts\"),\n    col = viridis(100),\n    cluster_rows = FALSE,\n    cluster_columns = FALSE,\n    row_names_side = \"left\",\n    column_names_side = \"top\",\n    column_names_rot = 90,\n    column_dend_side = \"bottom\",\n    row_names_gp = gpar(fontsize = 6),\n    cluster_column_slices = FALSE\n)\n```\n:::\n\n\n### Cell type frequence\n\n::: {.cell}\n\n```{.r .cell-code}\n### classify pDCs as myeloid cells for this large overview\nsample_info <- all_merged[[]] |> \n    select(sample, IE) |> \n    distinct() |> \n    as_tibble()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n### Full clusters by sample\ncluster_prop <- as.data.frame(\n    prop.table(\n        table(all_merged$sample, all_merged$RNA_snn_res.2), margin = 2\n    )\n)\ncolnames(cluster_prop) <- c(\"sample\", \"cluster\", \"proportion\")\n\nggplot(cluster_prop, aes(cluster, y = proportion, fill = sample)) +\n    geom_bar(stat = \"identity\") +\n    theme(axis.title.x = element_blank(), axis.title.y = element_blank(), axis.ticks.x = element_blank()) +\n    # coord_flip()+\n    theme(panel.background = element_blank(), axis.text.x = element_text(angle = 90, hjust = 1)) +\n    ggtitle(\"Sample composition by cell type\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n### Compare cell type frequencies\ncelltype_freq <- as.data.frame(table(all_merged$cell_type, all_merged$sample))\ncolnames(celltype_freq) <- c(\"cell_type\", \"sample\", \"cell_number\")\n\n### Absolute frequency\nggplot(celltype_freq, aes(sample, y = cell_number, fill = cell_type)) +\n    geom_bar(stat = \"identity\") +\n    theme(axis.title.x = element_blank(), axis.title.y = element_blank(), axis.ticks.x = element_blank()) +\n    # coord_flip()+\n    theme(panel.background = element_blank(), axis.text.x = element_text(angle = 90, hjust = 1)) +\n    ggtitle(\"Sample composition by cell type (absolute)\") ## Figure2\n\n### Relative frequency\ncelltype_prop <- as.data.frame(\n    prop.table(table(all_merged$cell_type, all_merged$sample), margin = 2)\n)\ncolnames(celltype_prop) <- c(\"cell_type\", \"sample\", \"proportion\")\n\nggplot(celltype_prop, aes(sample, y = proportion, fill = cell_type)) +\n    geom_bar(stat = \"identity\") +\n    theme(axis.title.x = element_blank(), axis.title.y = element_blank(), axis.ticks.x = element_blank()) +\n    # coord_flip()+\n    theme(\n        panel.background = element_blank(),\n        axis.text.x = element_text(angle = 90, hjust = 1)\n    ) +\n    ggtitle(\"Sample composition by cell type\")\n\n### Cell type proporations by sample group\ncelltype_prop <- celltype_prop |>\n    left_join(sample_info, by = \"sample\")\n\nggplot(celltype_prop, aes(x = IE, y = proportion, color = IE)) +\n    geom_boxplot() +\n    geom_point() +\n    facet_wrap(~cell_type, scales = \"fixed\", ncol = 4, strip.position = \"top\") +\n    theme(\n        axis.ticks.x = element_blank(),\n        axis.text.x = element_text(angle = 90, hjust = 1),\n        axis.title.x = element_blank(),\n        panel.background = element_blank(),\n        panel.border = element_rect(color = \"black\", fill = NA, linewidth = 1),\n        strip.background = element_blank(),\n        legend.background = element_blank()\n    ) +\n    ylab(\"Of total [%]\")\n```\n:::\n\n\n### Cytof vs 10x\n\n###  Cell numbers before and after filtering\n\n::: {.cell}\n\n```{.r .cell-code}\ncell_numbers <- read.csv(\n    here(path, \"03_Additional_files/CellsPerSample_PrePostFilter.csv\")\n)[-15, -4]\n\ncell_numbers$preFilter <- cell_numbers$preFilter - cell_numbers$postFilter\ncell_numbers <- cell_numbers |> \n    pivot_longer(\n        matches(\"Filter\"), names_to = \"filter\", values_to = \"cell_number\"\n    ) |> \n    mutate(\n        filter = factor(\n            filter, levels = c(\"preFilter\", \"postFilter\")\n        )\n    )\n\nggplot(cell_numbers, aes(Sample, cell_number, fill = filter)) +\n    geom_bar(stat = \"identity\") +\n    scale_fill_manual(\n        values = c(\"preFilter\" = \"dodgerblue\", \"postFilter\" = \"green4\")\n    ) +\n    theme(axis.title.x = element_blank(), axis.title.y = element_blank()) +\n    theme(axis.ticks.x = element_blank(),\n        axis.text.x = element_text(angle = 90, hjust = 1),\n        axis.title.x = element_blank(),\n        panel.background = element_blank(),\n        strip.background = element_blank(),\n        legend.background = element_blank()) +\n    ylab(\"Cell number\")\n```\n:::\n\n\n### Clinical information\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- read.csv(here(path, \"03_Additional_files/subtype_table.csv\"))[, -(28:32)]\n\n### Subtype distribution by TIG (stacked barplot)\ndf$Clinical.Subtype <- factor(\n    df$Clinical.Subtype, levels = c(\"LumA\", \"LumB\", \"LumB-HER2\", \"HER2\", \"TN\")\n)\np_type <- ggplot(df, aes(Clinical.Subtype, fill = Tumor.Immune.Group..CyTOF.based.))+\n  geom_bar()+\n  scale_x_discrete(drop=FALSE)+\n  scale_y_continuous(breaks = c(2,4,6,8))+\n   theme(axis.title.x=element_blank(), \n         axis.title.y = element_blank(),\n         panel.background = element_blank(),\n         panel.border = element_rect(color = \"black\", fill = \"NA\"),\n         axis.text.x = element_text(angle = 90, hjust=1),\n         legend.title = element_blank(),\n         axis.ticks.x = element_blank()) +\n  ggtitle(\"Clinical Subtypes by TIG\")\n\n### Age distribution by TIG (boxplots)\np_age <- ggplot(df, aes(x = Tumor.Immune.Group..CyTOF.based., y = Age.at.Surgery))+\n  geom_boxplot()+\n  geom_point()+\n   theme(axis.title.x=element_blank(), \n         axis.title.y = element_blank(),\n         panel.background = element_blank(),\n         panel.border = element_rect(color = \"black\", fill = \"NA\"),\n         axis.text.x = element_text(angle = 90, hjust=1),\n         legend.title = element_blank(),\n         axis.ticks.x = element_blank()) +\n  ggtitle(\"Age by TIG\")\n\n### Grade distribution by TIG (stacked barplot)\np_grade <- ggplot(df, aes(Grade, fill = Tumor.Immune.Group..CyTOF.based.))+\n  geom_bar()+\n  scale_x_discrete(drop=FALSE)+\n  scale_y_continuous(breaks = c(2,4,6,8))+\n   theme(axis.title.x=element_blank(), \n         axis.title.y = element_blank(),\n         panel.background = element_blank(),\n         panel.border = element_rect(color = \"black\", fill = \"NA\"),\n         axis.text.x = element_text(angle = 90, hjust=1),\n         legend.title = element_blank(),\n         axis.ticks.x = element_blank()) +\n  ggtitle(\"Grade by TIG\")\n\n### Combine plots\n(p_type | p_age | p_grade) + plot_layout(guides = \"collect\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n### Cell type freq distribution by clinical subtype (boxplots)\ncelltype_prop <- read.csv(\n    here(path, \"03_Additional_files/celltype_prop_sample_v2.csv\"), \n    header = TRUE\n) |> \n    left_join(df, by = \"Patient.ID\") |> \n    pivot_longer(\n        cols = 2:9, names_to = \"cell_type\", values_to = \"proportion\"\n    ) |> \n    relocate(cell_type, proportion, .after = \"Patient.ID\")\n\nsign_testing <- compare_means(\n    proportion ~ Clinical.Subtype, data = celltype_prop, \n    group.by = \"cell_type\"\n)\n\nggplot(celltype_prop, aes(x = Clinical.Subtype, y = proportion))+\n  geom_boxplot()+\n  geom_point()+\n  facet_wrap(~cell_type, scales=\"fixed\", ncol=4)+\n   theme(axis.title.x=element_blank(), \n         axis.title.y = element_blank(),\n         panel.background = element_blank(),\n         panel.border = element_rect(color = \"black\", fill = \"NA\"),\n         axis.text.x = element_text(angle = 90, hjust=1),\n         legend.title = element_blank(),\n         axis.ticks.x = element_blank(),\n         strip.background = element_blank()) +\n  ggtitle(\"Cell type frequency by subtype\")+\n  scale_y_continuous(limits = c(0,0.7))+\n  stat_compare_means(comparisons=list(c(\"LumA\", \"LumB\")), label = \"p.signif\")\n\n### Cell type freq distribution by grade (boxplots)\nsign_testing <- compare_means(\n    proportion~Grade, data = celltype_prop, group.by = \"cell_type\")\n\nmy_comparisons <- list(c(\"G1\", \"G2\"), c(\"G1\", \"G3\"), c(\"G2\", \"G3\"))\n\nggplot(celltype_prop, aes(x = Grade, y = proportion))+\n  geom_boxplot()+\n  geom_point()+\n  facet_wrap(~cell_type, scales=\"fixed\", ncol=4)+\n   theme(axis.title.x=element_blank(), \n         axis.title.y = element_blank(),\n         panel.background = element_blank(),\n         panel.border = element_rect(color = \"black\", fill = \"NA\"),\n         axis.text.x = element_text(angle = 90, hjust=1),\n         legend.title = element_blank(),\n         axis.ticks.x = element_blank(),\n         strip.background = element_blank()) +\n  ggtitle(\"Cell type frequency by subtype\")+\n  scale_y_continuous(limits = c(0,0.7))+\n  stat_compare_means(comparisons = my_comparisons, label = \"p.signif\")\n\n### Cell type freq by age (correlation plots)\nggplot(celltype_prop, aes(proportion, Age.at.Surgery))+\n  geom_point()+\n  facet_wrap(~cell_type, scales = \"free\", ncol = 4)+\n  stat_cor()+\n     theme(panel.background = element_blank(),\n         panel.border = element_rect(color = \"black\", fill = \"NA\"),\n         strip.background = element_blank()) +\n  ggtitle(\"Cell type frequency by age\")\n```\n:::\n\n\n## Figure2\n\n\n::: {.cell}\n\n```{.r .cell-code}\nTcells <- readRDS(here(scrna_dir, \"output/Tcells.rds\"))\n```\n:::\n\n\n### IE1 vs IE2 Volcano Plot\n\n::: {.cell}\n\n```{.r .cell-code}\nedger <- read.csv(\n    here(Tcell_dir, \"IE1vsIE2_EdgeR_samplesums_exactT_filtered.csv\")\n)\nedger$logFC <- -(edger$logFC)\n\n### Remove keratins\nedger <- filter(edger, !str_detect(X, \"^KRT\"))\nedger$X <- as.character(edger$X)\n\n### Remove all genes with logCPM < 1.5\nedger <- filter(edger, logCPM > 1.5)\n\nhighlight <- c(\n    \"HAVCR\", \"CDK1\", \"PTMS\", \"CSF1\", \"CD55\", \"GZMB\", \"PDCD1\", \"IL13\",\n    \"MKI67\", \"TNFRSF18\", \"CD276\", \"IRF4\", \"ITGAE\", \"CD8B\", \"TCF7\",\n    \"PDCD4\", \"GPR183\", \"CAMK1\", \"HAVCR2\", \"BATF\", \"TOX\", \"CCL3\", \"CXCR6\"\n)\n\nedger$color <- as.character(\n    ifelse(\n        edger$FDR < 0.1 & edger$logFC > 0.5, \"#F8766D\",\n        ifelse(edger$FDR < 0.1 & edger$logFC < -0.5, \"#00BFC4\", \"grey\")\n    )\n)\n\n# Plot with ggplot\nggplot(edger) +\n    geom_point(aes(logFC, -log(FDR)), color = edger$color) +\n    geom_label_repel(\n        data = subset(edger, X %in% highlight), aes(logFC, -log(FDR), label = X), min.segment.length = 0.1\n    ) +\n    geom_vline(xintercept = 0.5, linetype = \"dotted\", color = \"grey20\") +\n    geom_vline(xintercept = -0.5, linetype = \"dotted\", color = \"grey20\") +\n    geom_hline(\n        yintercept = -log(0.1), linetype = \"dotted\", color = \"grey20\"\n    ) +\n    theme(\n        panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank(),\n        panel.background = element_blank(),\n        panel.border = element_rect(colour = \"black\", fill = \"NA\")\n    )\n```\n:::\n\n\n### IE1 vs IE2 BoxPlot\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncounts <- read.csv(\n    here(Tcell_dir, \"sample_sum_counts.csv\"),\n    row.names = \"X\"\n)\ncolnames(counts)\n\n###  setup data table ###\nrawdat <- data.table::as.data.table(counts)\n\n### Normalize counts by dividing through library size\nrawdat_cpm <- apply(counts,2, function(x) (x/sum(x))*1000000)\ntdat = t(rawdat_cpm)\ntrnames <- row.names(tdat)\ntdat <- data.table::as.data.table(tdat)\ncolnames(tdat) = rownames(counts)\ntdat[, condition := trnames]\nTIG_list <- c(\n    \"IE1\", \"IE1\", \"IE1\", \"IE2\", \"IE2\", \"IE2\"\n)\ntdat[, TIG := TIG_list]\n\n### format the tables\ndat = data.table::melt(\n    tdat, id.vars=c('condition', 'TIG'), variable.name='gene', value.name = 'cpm' , variable.factor = FALSE\n)\n\n# gene list\nGOI <- c(\n    \"BATF\", \"IRF4\", \"CD55\", \"CD46\",  \"CSF1\", \"IL13\", \"CCL3\", \"CXCR6\", \n    \"TCF7\", \"TOX\"\n)\n\n### plot together with edger values\nedger$gene <- edger$X\nedger$FDR_x = paste0('FDR = ',signif(edger$FDR, digits=3))\nedger$p = paste0('p = ',signif(edger$PValue, digits=2))\n\nsubset(dat, gene %in% GOI) |> \n  merge(edger, by='gene') |> \n  ggplot(aes(x=gene,y=cpm,color=TIG))+\n  facet_wrap(~gene+FDR_x+p, scales = \"free\", ncol = 3)+\n  geom_boxplot()+\n  geom_point(position = position_jitterdodge(jitter.width = 0, jitter.height = 0, dodge.width = 0.75))+\n  expand_limits(x=0,y=0)+\n  theme_bw()+\n  theme(axis.line.x = element_line(colour = \"black\", size = 0.25),\n        axis.line.y = element_line(colour = \"black\", size = 0.25),\n        panel.grid.major = element_blank(),\n        panel.grid.minor = element_blank(),\n        panel.border = element_rect(colour = \"black\", fill=\"NA\"),\n        panel.background = element_blank(),\n        axis.title.x=element_blank(),\n        axis.text.x=element_blank(),\n        #strip.background = element_blank(),\n        axis.ticks.x=element_blank())\n```\n:::\n\n\n## SessionInfo\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\nsessionInfo()\n```\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}