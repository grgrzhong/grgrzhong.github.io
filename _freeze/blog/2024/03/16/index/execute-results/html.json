{
  "hash": "e9f7f760038a4fd7e58f3a88dc00a3a2",
  "result": {
    "markdown": "---\ntitle: \"Seurat V5 | Single Cell Data analysis\"\ndate: 2024-03-16\ndate-modified: last-modified\ncategories:\n  - seurat\n  - scrna\nimage: ./projects/scRNA-seq_online/img/scRNA-seq_cell_diversity.png\ndescription: All the learning materials are from credited or adapted from Harvard Chan Bioinformatics Core. \nexecute: \n  freeze: true\n  eval: false\n\n---\n\n\n\n## Install and Load required packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# install.packages('Seurat')\n# library(Seurat)\n\n# setRepositories(\n#     ind = 1:3,\n#     addURLs = c(\n#         'https://satijalab.r-universe.dev', 'https://bnprks.r-universe.dev/'\n#     )\n# )\n# install.packages(c(\"BPCells\", \"presto\", \"glmGamPoi\"))\n\n# # Install the remotes package\n# if (!requireNamespace(\"remotes\", quietly = TRUE)) {\n#   install.packages(\"remotes\")\n# }\n\n# install.packages(\"Signac\")\n# remotes::install_github(\"satijalab/azimuth\", quiet = TRUE)\n# remotes::install_github(\"satijalab/seurat-data\", quiet = TRUE)\n# remotes::install_github(\"satijalab/seurat-wrappers\", quiet = TRUE)\n\n# BiocManager::install(c(\"AnnotationHub\", \"ensembldb\", \"multtest\", \"glmGamPoi\"))\n\nInstallData(\"pbmcsca\")\nInstallData(\"ifnb\")\n\nlibrary(fs)\nlibrary(here)\nlibrary(tidyverse)\nlibrary(patchwork)\nlibrary(cowplot)\nlibrary(Seurat)\nlibrary(SeuratData)\nlibrary(SeuratWrappers)\nlibrary(Azimuth)\n# library(AnnotationHub)\n# library(ensembldb)\n\noptions(future.globals.maxSize = 3e+09)\n```\n:::\n\n\n## scRNA-seq integration Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# UpdateSeuratObject(ifnb)\n# install.packages(\n#   here(\"blog/2024/03/16/ifnb.SeuratData_3.1.0.tar.gz\"),\n#   repos = NULL, type = \"source\"\n# )\n\n# library(ifnb.SeuratData)\n\nifnb <- LoadData(\"ifnb\")\n\nifnb[[\"RNA\"]] <- split(ifnb[[\"RNA\"]], f = ifnb$stim)\n\nifnb[[]] |> head()\n```\n:::\n\n### Perform analysis without integration\n\n\n::: {.cell}\n\n```{.r .cell-code}\nifnb <- NormalizeData(ifnb) |>\n    FindVariableFeatures() |>\n    ScaleData() |>\n    RunPCA() |>\n    FindNeighbors(dims = 1:30, reduction = \"pca\") |>\n    FindClusters(resolution = 2, cluster.name = \"unintegrated_clusters\") |>\n    RunUMAP(\n        dims = 1:30, reduction = \"pca\", reduction.name = \"umap.unintegrated\"\n    )\n\np1 <- DimPlot(\n    ifnb, reduction = \"umap.unintegrated\",\n    group.by = c(\"stim\", \"seurat_clusters\")\n)\n```\n:::\n\n### Perform integration\n\n\n::: {.cell}\n\n```{.r .cell-code}\nifnb <- IntegrateLayers(\n    object = ifnb,\n    method = CCAIntegration,\n    orig.reduction = \"pca\",\n    new.reduction = \"integrated.cca\",\n    verbose = FALSE\n)\n\n### re-join layers after integration\nifnb[[\"RNA\"]] <- JoinLayers(ifnb[[\"RNA\"]])\n\nifnb <- FindNeighbors(ifnb, reduction = \"integrated.cca\", dims = 1:30) |>\n    FindClusters(resolution = 1) |>\n    RunUMAP(dims = 1:30, reduction = \"integrated.cca\")\n\np2 <- DimPlot(\n    ifnb, reduction = \"umap\", group.by = c(\"stim\", \"seurat_annotations\")\n)\n\nwrap_plots(p1, p2, ncol = 1)\n\nDimPlot(ifnb, reduction = \"umap\", split.by = \"stim\", label = TRUE)\n```\n:::\n\n### Identify canonical cell type marker genes that are conserved across conditions\n\n\n::: {.cell}\n\n```{.r .cell-code}\n### Identify canonical cell type marker genes that are conserved across conditions\nIdents(ifnb) <- \"seurat_annotations\"\n\nnk.markers <- FindConservedMarkers(\n    ifnb, ident.1 = \"NK\", grouping.var = \"stim\", verbose = FALSE\n)\n\nhead(nk.markers)\n\nifnb[[]] |> head()\n\n### NEEDS TO BE FIXED AND SET ORDER CORRECTLY\nIdents(ifnb) <- factor(\n    Idents(ifnb),\n    levels = c(\n        \"pDC\", \"Eryth\", \"Mk\", \"DC\", \"CD14 Mono\", \"CD16 Mono\", \"B Activated\", \"B\",\n        \"CD8 T\", \"NK\", \"T activated\", \"CD4 Naive T\", \"CD4 Memory T\"\n    )\n)\n\nmarkers.to.plot <- c(\n    \"CD3D\", \"CREM\", \"HSPH1\", \"SELL\", \"GIMAP5\", \"CACYBP\", \"GNLY\", \"NKG7\", \"CCL5\",\n    \"CD8A\", \"MS4A1\", \"CD79A\", \"MIR155HG\", \"NME1\", \"FCGR3A\", \"VMO1\", \"CCL2\",\n    \"S100A9\", \"HLA-DQA1\", \"GPR183\", \"PPBP\", \"GNG11\", \"HBA2\", \"HBB\", \"TSPAN13\",\n    \"IL3RA\", \"IGJ\", \"PRSS57\"\n)\n\nDotPlot(\n    ifnb, features = markers.to.plot, cols = c(\"blue\", \"red\"),\n    dot.scale = 8, split.by = \"stim\"\n) +\n    RotatedAxis()\n```\n:::\n\n\n### Identify differential expressed genes across conditions\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_set(theme_cowplot())\n\n### Compare gene expression before and after stimulation\naggregate_ifnb <- AggregateExpression(\n    ifnb, group.by = c(\"seurat_annotations\", \"stim\"), return.seurat = TRUE\n)\n\n### conserved interferon response pathway\ngenes.to.label = c(\n    \"ISG15\", \"LY6E\", \"IFI6\", \"ISG20\", \"MX1\", \"IFIT2\", \"IFIT1\", \"CXCL10\", \"CCL8\"\n)\n\np1 <- CellScatter(\n    aggregate_ifnb, \"CD14 Mono_CTRL\", \"CD14 Mono_STIM\",\n    highlight = genes.to.label\n)\n\np2 <- LabelPoints(plot = p1, points = genes.to.label, repel = TRUE)\n\np3 <- CellScatter(\n    aggregate_ifnb, \"CD4 Naive T_CTRL\", \"CD4 Naive T_STIM\",\n    highlight = genes.to.label\n)\n\np4 <- LabelPoints(plot = p3, points = genes.to.label, repel = TRUE)\n\np2 + p4\n\n### Find the genes that are different between stimulated and control B cells\nifnb$celltype.stim <- paste(ifnb$seurat_annotations, ifnb$stim, sep = \"_\")\n\nIdents(ifnb) <- \"celltype.stim\"\n\nlevels(Idents(ifnb))\n\nb.interferon.response <- FindMarkers(\n    ifnb, ident.1 = \"B_STIM\", ident.2 = \"B_CTRL\", verbose = FALSE\n)\n\nhead(b.interferon.response, n = 15)\n\nFeaturePlot(\n    ifnb,\n    features = c(\"CD3D\", \"GNLY\", \"IFI6\"),\n    split.by = \"stim\",\n    max.cutoff = 3,\n    cols = c(\"grey\", \"red\"),\n    reduction = \"umap\"\n)\n\nplots <- VlnPlot(\n    ifnb, features = c(\"LYZ\", \"ISG15\", \"CXCL10\"), split.by = \"stim\",\n    group.by = \"seurat_annotations\",\n    pt.size = 0, combine = FALSE\n)\nwrap_plots(plots = plots, ncol = 1)\n```\n:::\n\n\n### Perform integration with SCTransform-normalized datasets\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nifnb <- LoadData(\"ifnb\")\n\nifnb[[\"RNA\"]] <- split(ifnb[[\"RNA\"]], f = ifnb$stim)\n\nifnb <- SCTransform(ifnb)\nifnb <- RunPCA(ifnb)\nifnb <- RunUMAP(ifnb, dims = 1:30)\nDimPlot(ifnb, reduction = \"umap\", group.by = c(\"stim\", \"seurat_annotations\"))\n\n### integrate datasets\nifnb <- IntegrateLayers(\n  object = ifnb, method = CCAIntegration, normalization.method = \"SCT\", \n  verbose = F\n)\nifnb <- FindNeighbors(ifnb, reduction = \"integrated.dr\", dims = 1:30)\nifnb <- FindClusters(ifnb, resolution = 0.6)\n\nifnb <- RunUMAP(ifnb, dims = 1:30, reduction = \"integrated.dr\")\nDimPlot(ifnb, reduction = \"umap\", group.by = c(\"stim\", \"seurat_annotations\"))\n\n### Perform differential expression\nifnb <- PrepSCTFindMarkers(ifnb)\nifnb$celltype.stim <- paste(ifnb$seurat_annotations, ifnb$stim, sep = \"_\")\nIdents(ifnb) <- \"celltype.stim\"\nb.interferon.response <- FindMarkers(\n  ifnb, ident.1 = \"B_STIM\", ident.2 = \"B_CTRL\", verbose = FALSE\n)\n```\n:::\n\n## DE analysis across conditions\n\n## Azimuth annotation\n\n\n::: {.cell}\n\n```{.r .cell-code}\npbmcsca <- LoadData(\"pbmcsca\")\n\npbmcsca[[]] |> head()\n\npbmcsca <- RunAzimuth(pbmcsca, reference = \"pbmcref\")\n\npbmcsca[[]][1:6, ]\n\npbmcsca <- RunAzimuth(pbmcsca, reference = \"pbmcref\")\n\np1 <- DimPlot(\n    pbmcsca, group.by = \"predicted.celltype.l2\", label = TRUE, label.size = 3\n) +\n    NoLegend()\n\np2 <- DimPlot(pbmcsca, group.by = \"Method\")\np1 + p2\n\npbmcsca <- NormalizeData(pbmcsca)\n\nIdents(pbmcsca) <- \"predicted.celltype.l2\"\ntable(Idents(pbmcsca))\n\n### CCR7 on CD4 and CD8 Naive T cells\np1 <- FeaturePlot(pbmcsca, features = \"CCR7\")\n\n### FCGR3A on CD16+ monocytes, CD56dim NK cells, and cytotoxic CD8 T cells\np2 <- FeaturePlot(pbmcsca, features = \"FCGR3A\")\n\n### AXL on rare populations of AXL+SIGLEC6+ dendritic cells\np3 <- VlnPlot(\n  pbmcsca, features = \"AXL\", group.by = \"predicted.celltype.l2\", \n  idents = c(\"ASDC\",\"pDC\", \"cDC1\", \"cDC2\")\n)\np4 <- FeaturePlot(pbmcsca, features = \"predictionscorecelltypel2_Treg\")\n\n### Prediction scores for the annotation CD4+ regulatory T cells (Treg)\np1 + p2 + p3 + p4 + plot_layout(ncol = 2)\n```\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}