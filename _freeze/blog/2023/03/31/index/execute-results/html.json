{
  "hash": "7f6cd29dbd56e7928855dd6093b0a149",
  "result": {
    "markdown": "---\ntitle: \"Add p-value and significant level at facet boxplot\"\ndate: 2023-03-31\ncategories:\n  - r\n  - p-value\n  - ggplot2\nimage: plot.png\n---\n\n\n\nHow to compute and add p-values to basic ggplots using the rstatix and the ggpubr R packages.\n\n:::{.callout-note}\n1. Compute easily statistical tests (`t_test()` or `wilcox_test()`) using the `rstatix` package\n2. Auto-compute p-value label positions using the function `add_xy_position()` [in rstatix package].\n3. Add the p-values to the plot using the function `stat_pvalue_manual()` [in ggpubr package]. The following key options are illustrated in some of the examples:\n- The option `bracket.nudge.y` is used to move up or to move down the brackets.\n- The option `step.increase` is used to add more space between brackets.\n- The option `vjust` is used to vertically adjust the position of the p-values labels\n\n4. In some situations, the p-value labels are partially hidden by the plot top border. In these cases, the ggplot2 function `scale_y_continuous(expand = expansion(mult = c(0, 0.1)))` can be used to add more spaces between labels and the plot top border. The option mult = c(0, 0.1) indicates that 0% and 10% spaces are respectively added at the bottom and the top of the plot. \n:::\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npacman::p_load(\n    tidyverse,\n    ggsci,\n    ggprism,\n    rstatix,\n    ggpubr,\n    gapminder,\n    ggpmisc\n)\n```\n:::\n\n\n## Add t-test annotation in specific subgroup \n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n## subset data\ndf <- gapminder %>%\n    filter(year %in% c(1957, 2002, 2007), continent != \"Oceania\") %>%\n    select(country, year, lifeExp, continent) %>%\n    mutate(paired = rep(1:(n() / 3), each = 3), year = factor(year))\ndf\n## # A tibble: 420 × 5\n##    country     year  lifeExp continent paired\n##    <fct>       <fct>   <dbl> <fct>      <int>\n##  1 Afghanistan 1957     30.3 Asia           1\n##  2 Afghanistan 2002     42.1 Asia           1\n##  3 Afghanistan 2007     43.8 Asia           1\n##  4 Albania     1957     59.3 Europe         2\n##  5 Albania     2002     75.7 Europe         2\n##  6 Albania     2007     76.4 Europe         2\n##  7 Algeria     1957     45.7 Africa         3\n##  8 Algeria     2002     71.0 Africa         3\n##  9 Algeria     2007     72.3 Africa         3\n## 10 Angola      1957     32.0 Africa         4\n## # ℹ 410 more rows\n## statistical analysis\ndf_pval <- df %>%\n    group_by(continent) %>%\n    wilcox_test(lifeExp ~ year) %>%\n    adjust_pvalue(p.col = \"p\", method = \"bonferroni\") %>%\n    add_significance(p.col = \"p.adj\") %>%\n    add_xy_position(x = \"year\", dodge = 0.8)\ndf_pval\n## # A tibble: 12 × 14\n##    continent .y.     group1 group2    n1    n2 statistic        p    p.adj\n##    <fct>     <chr>   <chr>  <chr>  <int> <int>     <dbl>    <dbl>    <dbl>\n##  1 Africa    lifeExp 1957   2002      52    52       328 2.85e-11 3.42e-10\n##  2 Africa    lifeExp 1957   2007      52    52       255 1.01e-12 1.21e-11\n##  3 Africa    lifeExp 2002   2007      52    52      1214 3.71e- 1 1   e+ 0\n##  4 Americas  lifeExp 1957   2002      25    25        23 9.12e-11 1.09e- 9\n##  5 Americas  lifeExp 1957   2007      25    25        14 8.04e-12 9.65e-11\n##  6 Americas  lifeExp 2002   2007      25    25       250 2.31e- 1 1   e+ 0\n##  7 Asia      lifeExp 1957   2002      33    33        73 1.23e-11 1.48e-10\n##  8 Asia      lifeExp 1957   2007      33    33        56 9.62e-13 1.15e-11\n##  9 Asia      lifeExp 2002   2007      33    33       476 3.86e- 1 1   e+ 0\n## 10 Europe    lifeExp 1957   2002      30    30        19 3.53e-14 4.24e-13\n## 11 Europe    lifeExp 1957   2007      30    30        13 6.31e-15 7.57e-14\n## 12 Europe    lifeExp 2002   2007      30    30       358 1.77e- 1 1   e+ 0\n## # ℹ 5 more variables: p.adj.signif <chr>, y.position <dbl>,\n## #   groups <named list>, xmin <dbl>, xmax <dbl>\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndf %>%\n    ggplot(aes(x = year, y = lifeExp)) +\n    stat_boxplot(aes(ymin = ..lower.., ymax = ..upper..), outlier.shape = NA, width = 0.5) +\n    stat_boxplot(geom = \"errorbar\", aes(ymin = ..ymax..), width = 0.2, size = 0.35) +\n    stat_boxplot(geom = \"errorbar\", aes(ymax = ..ymin..), width = 0.2, size = 0.35) +\n    geom_boxplot(aes(fill = year), color = \"black\", outlier.shape = NA, linetype = \"dashed\", width = 0.5, size = 0.3) +\n    stat_summary(geom = \"crossbar\", fun = \"median\", width = 0.5, color = \"black\", size = 0.38) +\n    scale_size_continuous(range = c(1, 3)) +\n    facet_wrap(. ~ continent, nrow = 1) +\n    scale_fill_npg() +\n    scale_y_continuous(limits = c(0, 95), breaks = seq(0, 95, 15), guide = \"prism_offset_minor\") +\n    labs(x = NULL, y = NULL) +\n    theme(\n        plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), units = \"cm\"),\n        strip.text = element_text(size = 12),\n        axis.line = element_line(color = \"black\", size = 0.4),\n        panel.grid.major = element_line(size = 0.2, color = \"#e5e5e5\"),\n        panel.grid.minor = element_blank(),\n        panel.background = element_blank(),\n        panel.spacing = unit(0.1, \"lines\"),\n        axis.text.y = element_text(color = \"black\", size = 10),\n        # axis.text.x = element_blank(),\n        # axis.ticks.x = element_blank(),\n        legend.position = \"none\"\n    ) +\n    coord_cartesian() +\n    ### add p-value\n    stat_pvalue_manual(\n        df_pval %>% filter(\n            continent %in% c(\"Asia\", \"Americas\"), group1 == \"1957\", group2 == \"2002\"\n        ),\n        label = \"p.adj.signif\", label.size = 5, hide.ns = F\n    )\n## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\n## ℹ Please use `linewidth` instead.\n## Warning: The `size` argument of `element_line()` is deprecated as of ggplot2 3.4.0.\n## ℹ Please use the `linewidth` argument instead.\n## Warning: The dot-dot notation (`..lower..`) was deprecated in ggplot2 3.4.0.\n## ℹ Please use `after_stat(lower)` instead.\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){fig-align='center' width=672}\n:::\n:::\n\n## Paried t-test in subgroup facet\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n### Boxplot Parired t-test multiple group\ndf %>%\n    ggplot(aes(year, lifeExp)) +\n    stat_boxplot(geom = \"errorbar\", position = position_dodge(width = 0.2), width = 0.1) +\n    geom_boxplot(position = position_dodge(width = 0.2), width = 0.4) +\n    geom_line(aes(group = paired), position = position_dodge(0.2), color = \"grey80\") +\n    geom_point(aes(fill = year, group = paired, size = lifeExp, alpha = lifeExp),\n        pch = 21,\n        position = position_dodge(0.2)\n    ) +\n    stat_pvalue_manual(df_pval, label = \"p.adj.signif\", label.size = 6, hide.ns = T) +\n    scale_size_continuous(range = c(1, 3)) +\n    facet_wrap(. ~ continent, nrow = 1) +\n    scale_fill_npg() +\n    scale_x_discrete(guide = \"prism_bracket\") +\n    scale_y_continuous(limits = c(0, 90), minor_breaks = seq(0, 90, 5), guide = \"prism_offset_minor\") +\n    labs(x = NULL, y = NULL) +\n    theme_prism(base_line_size = 0.5) +\n    theme(\n        plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), units = , \"cm\"),\n        axis.line = element_line(color = \"black\", size = 0.4),\n        panel.grid.minor = element_blank(),\n        panel.grid.major = element_line(size = 0.2, color = \"#e5e5e5\"),\n        axis.text.y = element_text(color = \"black\", size = 10),\n        axis.text.x = element_text(margin = margin(t = -5), color = \"black\", size = 10),\n        legend.position = \"none\",\n        panel.spacing = unit(0, \"lines\")\n    ) +\n    coord_cartesian()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){fig-align='center' width=672}\n:::\n\n```{.r .cell-code}\n# ggsave(\n#     here(\"blog\", \"2023\", \"03\", \"07\", \"plot.png\")\n# )\n```\n:::\n\n## Boxplot\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndf %>%\n    ggplot(aes(year, lifeExp)) +\n    stat_boxplot(geom = \"errorbar\", position = position_dodge(width = 0.2), width = 0.1) +\n    geom_boxplot(position = position_dodge(width = 0.2), width = 0.4) +\n    #  geom_line(aes(group=paired),position = position_dodge(0.2),color=\"grey80\") +\n    geom_point(aes(fill = year, group = paired, size = lifeExp, alpha = lifeExp),\n        pch = 21,\n        position = position_dodge(0.2)\n    ) +\n    stat_pvalue_manual(df_pval, label = \"p.adj.signif\", label.size = 5, hide.ns = F) +\n    scale_size_continuous(range = c(1, 3)) +\n    geom_smooth(method = \"lm\", formula = NULL, size = 1, se = T, color = \"black\", linetype = \"dashed\", aes(group = 1)) +\n    stat_cor(\n        label.y = 25, aes(label = paste(..rr.label.., ..p.label.., sep = \"~`,`~\"), group = 1), color = \"black\",\n        label.x.npc = \"left\"\n    ) +\n    stat_regline_equation(label.y = 19, aes(group = 1), color = \"red\") +\n    facet_wrap(. ~ continent, nrow = 1) +\n    scale_fill_npg() +\n    scale_x_discrete(guide = \"prism_bracket\") +\n    scale_y_continuous(limits = c(0, 95), minor_breaks = seq(0, 95, 5), guide = \"prism_offset_minor\") +\n    labs(x = NULL, y = NULL) +\n    theme_prism(base_line_size = 0.5) +\n    theme(\n        plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), units = , \"cm\"),\n        strip.text = element_text(size = 12),\n        axis.line = element_line(color = \"black\", size = 0.4),\n        panel.grid.minor = element_blank(),\n        panel.grid.major = element_line(size = 0.2, color = \"#e5e5e5\"),\n        axis.text.y = element_text(color = \"black\", size = 10),\n        axis.text.x = element_text(margin = margin(t = -5), color = \"black\", size = 10),\n        legend.position = \"none\",\n        panel.spacing = unit(0, \"lines\")\n    ) +\n    coord_cartesian()\n## `geom_smooth()` using formula = 'y ~ x'\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){fig-align='center' width=672}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}