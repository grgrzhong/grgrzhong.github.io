<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Guorui Zhong">
<meta name="description" content="All the learning materials are from credited or adapted from Harvard Chan Bioinformatics Core.">
<title>Seurat V5 | Learning Single-cell RNA-seq data analysis from HBCtraining workshop – Guorui Zhong</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<script src="../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting-cee8642dd6abb73bb51e0193ec9c0780.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap-a122eddc3d35102178d4fe042f5b75d5.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #212529;
      }
</style>
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../index.html">
    <span class="navbar-title">Guorui Zhong</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../wiki/index.html"> 
<span class="menu-text">Wiki</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../programming/linux/index.html"> 
<span class="menu-text">Linux</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../programming/python/index.html"> 
<span class="menu-text">Python</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../programming/r/index.html"> 
<span class="menu-text">R</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../keyboard/index.html"> 
<span class="menu-text">Keyboard</span></a>
  </li>  
</ul>
<ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://scholar.google.com/citations?user=g0MfTPMAAAAJ&amp;hl=en"> <i class="bi bi-journal-check" role="img" aria-label="journal-check">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/guorui-zhong-754761185/"> <i class="bi bi-linkedin" role="img" aria-label="linkedin">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/guoruizhong"> <i class="bi bi-github" role="img" aria-label="github">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Seurat V5 | Learning Single-cell RNA-seq data analysis from HBCtraining workshop</h1>
                  <div>
        <div class="description">
          All the learning materials are from credited or adapted from Harvard Chan Bioinformatics Core.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">seurat</div>
                <div class="quarto-category">scrna</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://grgrzhong.github.io/">Guorui Zhong</a> <a href="https://orcid.org/0000-0002-1955-2847" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Sunday, February 25, 2024</p>
      </div>
    </div>
    
      <div>
      <div class="quarto-title-meta-heading">Modified</div>
      <div class="quarto-title-meta-contents">
        <p class="date-modified">Wednesday, April 10, 2024</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li><a href="#install-and-load-required-packages" id="toc-install-and-load-required-packages" class="nav-link active" data-scroll-target="#install-and-load-required-packages">Install and Load required packages</a></li>
  <li>
<a href="#introduction-to-single-cell-rna-seq" id="toc-introduction-to-single-cell-rna-seq" class="nav-link" data-scroll-target="#introduction-to-single-cell-rna-seq">Introduction to single-cell RNA-seq</a>
  <ul class="collapse">
<li><a href="#why-single-cell-rna-seq" id="toc-why-single-cell-rna-seq" class="nav-link" data-scroll-target="#why-single-cell-rna-seq">Why single-cell RNA-seq</a></li>
  <li><a href="#challenges-of-scrna-seq-analysis" id="toc-challenges-of-scrna-seq-analysis" class="nav-link" data-scroll-target="#challenges-of-scrna-seq-analysis">Challenges of scRNA-seq analysis</a></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions">Conclusions</a></li>
  </ul>
</li>
  <li>
<a href="#raw-data-to-count-matrix" id="toc-raw-data-to-count-matrix" class="nav-link" data-scroll-target="#raw-data-to-count-matrix">Raw data to count matrix</a>
  <ul class="collapse">
<li><a href="#end-reads-includes-all-droplet-based-methods" id="toc-end-reads-includes-all-droplet-based-methods" class="nav-link" data-scroll-target="#end-reads-includes-all-droplet-based-methods">3’-end reads (includes all droplet-based methods)</a></li>
  <li><a href="#generation-of-count-matrix" id="toc-generation-of-count-matrix" class="nav-link" data-scroll-target="#generation-of-count-matrix">Generation of count matrix</a></li>
  </ul>
</li>
  <li>
<a href="#quality-control" id="toc-quality-control" class="nav-link" data-scroll-target="#quality-control">Quality Control</a>
  <ul class="collapse">
<li><a href="#explore-the-example-dataset" id="toc-explore-the-example-dataset" class="nav-link" data-scroll-target="#explore-the-example-dataset">Explore the example dataset</a></li>
  <li><a href="#generating-quality-metrics" id="toc-generating-quality-metrics" class="nav-link" data-scroll-target="#generating-quality-metrics">Generating quality metrics</a></li>
  <li><a href="#novelty-score" id="toc-novelty-score" class="nav-link" data-scroll-target="#novelty-score">Novelty score</a></li>
  <li><a href="#mitochondrial-ratio" id="toc-mitochondrial-ratio" class="nav-link" data-scroll-target="#mitochondrial-ratio">Mitochondrial Ratio</a></li>
  <li><a href="#additional-metadata-columns" id="toc-additional-metadata-columns" class="nav-link" data-scroll-target="#additional-metadata-columns">Additional metadata columns</a></li>
  <li><a href="#assessing-the-quality-metrics" id="toc-assessing-the-quality-metrics" class="nav-link" data-scroll-target="#assessing-the-quality-metrics">Assessing the quality metrics</a></li>
  <li><a href="#genes-detected-per-cell" id="toc-genes-detected-per-cell" class="nav-link" data-scroll-target="#genes-detected-per-cell">Genes detected per cell</a></li>
  <li><a href="#complexity" id="toc-complexity" class="nav-link" data-scroll-target="#complexity">Complexity</a></li>
  <li><a href="#mitochondrial-counts-ratio" id="toc-mitochondrial-counts-ratio" class="nav-link" data-scroll-target="#mitochondrial-counts-ratio">Mitochondrial counts ratio</a></li>
  <li><a href="#joint-filtering-effects" id="toc-joint-filtering-effects" class="nav-link" data-scroll-target="#joint-filtering-effects">Joint filtering effects</a></li>
  <li><a href="#perform-filtering" id="toc-perform-filtering" class="nav-link" data-scroll-target="#perform-filtering">Perform filtering</a></li>
  <li><a href="#re-assess-qc-metrics" id="toc-re-assess-qc-metrics" class="nav-link" data-scroll-target="#re-assess-qc-metrics">Re-assess QC metrics</a></li>
  </ul>
</li>
  <li>
<a href="#normalization" id="toc-normalization" class="nav-link" data-scroll-target="#normalization">Normalization</a>
  <ul class="collapse">
<li><a href="#explore-sources-of-unwanted-variation" id="toc-explore-sources-of-unwanted-variation" class="nav-link" data-scroll-target="#explore-sources-of-unwanted-variation">Explore sources of unwanted variation</a></li>
  <li><a href="#normalization-and-regressing-out-sources-of-unwanted-variation-using-sctransform" id="toc-normalization-and-regressing-out-sources-of-unwanted-variation-using-sctransform" class="nav-link" data-scroll-target="#normalization-and-regressing-out-sources-of-unwanted-variation-using-sctransform">Normalization and regressing out sources of unwanted variation using SCTransform</a></li>
  </ul>
</li>
  <li>
<a href="#integration" id="toc-integration" class="nav-link" data-scroll-target="#integration">Integration</a>
  <ul class="collapse">
<li><a href="#to-integrate-or-not-to-integrate" id="toc-to-integrate-or-not-to-integrate" class="nav-link" data-scroll-target="#to-integrate-or-not-to-integrate">To integrate or not to integrate?</a></li>
  <li><a href="#integrate-or-align-samples-across-conditions-using-shared-highly-variable-genes" id="toc-integrate-or-align-samples-across-conditions-using-shared-highly-variable-genes" class="nav-link" data-scroll-target="#integrate-or-align-samples-across-conditions-using-shared-highly-variable-genes">Integrate or align samples across conditions using shared highly variable genes</a></li>
  <li><a href="#integration-using-cca" id="toc-integration-using-cca" class="nav-link" data-scroll-target="#integration-using-cca">Integration using CCA</a></li>
  </ul>
</li>
  <li>
<a href="#clustering" id="toc-clustering" class="nav-link" data-scroll-target="#clustering">Clustering</a>
  <ul class="collapse">
<li><a href="#clustering-cells-based-on-top-pcs-metagenes" id="toc-clustering-cells-based-on-top-pcs-metagenes" class="nav-link" data-scroll-target="#clustering-cells-based-on-top-pcs-metagenes">Clustering cells based on top PCs (metagenes)</a></li>
  <li><a href="#exploration-of-quality-control-metrics" id="toc-exploration-of-quality-control-metrics" class="nav-link" data-scroll-target="#exploration-of-quality-control-metrics">Exploration of quality control metrics</a></li>
  </ul>
</li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session Info</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>!!!Note: All the contents are credited or adapted from <a href="https://hbctraining.github.io/scRNA-seq_online/schedule/links-to-lessons.html">HBC Single-cell RNA-seq data analysis workshop</a> for leaning purpose.</p>
</div>
</div>
<section id="install-and-load-required-packages" class="level2"><h2 class="anchored" data-anchor-id="install-and-load-required-packages">Install and Load required packages</h2>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># BiocManager::install(c("AnnotationHub", "ensembldb", "multtest", "glmGamPoi"))</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/">here</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org">fs</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/nx10/httpgd">httpgd</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.satijalab.org/seurat">SeuratData</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org">Matrix</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">RCurl</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/">cowplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">metap</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">AnnotationHub</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jorainer/ensembldb">ensembldb</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">multtest</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/const-ae/glmGamPoi">glmGamPoi</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">SingleCellExperiment</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="introduction-to-single-cell-rna-seq" class="level2"><h2 class="anchored" data-anchor-id="introduction-to-single-cell-rna-seq">Introduction to single-cell RNA-seq</h2>
<section id="why-single-cell-rna-seq" class="level3"><h3 class="anchored" data-anchor-id="why-single-cell-rna-seq">Why single-cell RNA-seq</h3>
<p>Across human tissue there is an incredible diversity of cell cell types, states, and interactions. To better understand these tissues and the cell types present, single-cell RNA-seq (scRNA-seq) offers a glimpse into what genes are being expressed at the level of individual cells.</p>
<p align="center">
<img src="./projects/scRNA-seq_online/img/scRNA-seq_cell_diversity.png" width="600"></p>
<p>This exciting and cutting-edge method can be used to:</p>
<ul>
<li>explore which cell types are present in a tissue</li>
<li>identify unknown/rare cell types or states</li>
<li>elucidate the changes in gene expression during differentiation processes or across time or states</li>
<li>identify genes that are differentially expressed in particular cell types between conditions (e.g.&nbsp;treatment or disease)</li>
<li>explore changes in expression among a cell type while incorporating spatial, regulatory, and/or protein information</li>
</ul></section><section id="challenges-of-scrna-seq-analysis" class="level3"><h3 class="anchored" data-anchor-id="challenges-of-scrna-seq-analysis">Challenges of scRNA-seq analysis</h3>
<p>Despite scRNA-seq being able to capture expression at the cellular level, sample generation and library preparation is more expensive and the analysis is much more complicated and more difficult to interpret. The complexity of analysis of scRNA-seq data involves:</p>
<ul>
<li>Large volume of data</li>
<li>Low depth of sequencing per cell</li>
<li>Technical variability across cells/samples</li>
<li>Biological variability across cells/samples</li>
</ul>
<section id="large-volumne-of-data" class="level4"><h4 class="anchored" data-anchor-id="large-volumne-of-data">Large volumne of data</h4>
<p>Expression data from scRNA-seq experiments represent tens or hundreds of thousands of reads for thousands of cells. The data output is much larger, requiring higher amounts of memory to analyze, larger storage requirements, and more time to run the analyses.</p>
</section><section id="low-depth-of-sequencing-per-cell" class="level4"><h4 class="anchored" data-anchor-id="low-depth-of-sequencing-per-cell">Low depth of sequencing per cell</h4>
<p>For the droplet-based methods of scRNA-seq, the depth of sequencing is shallow, often detecting only 10-50% of the transcriptome per cell. This results in cells showing zero counts for many of the genes. However, in a particular cell, a zero count for a gene could either mean that the gene was <em>not being expressed</em> or the transcripts were just <em>not detected</em>. Across cells, genes with higher levels of expression tend to have fewer zeros. Due to this feature, many genes will not be detected in any cell and gene expression will be highly variable between cells.</p>
</section><section id="biological-variability-across-cellssamples" class="level4"><h4 class="anchored" data-anchor-id="biological-variability-across-cellssamples">Biological variability across cells/samples</h4>
<p>Uninteresting sources of biological variation can result in gene expression between cells being more similar/different than the actual biological cell types/states, which can obscure the cell type identities. Uninteresting sources of biological variation (unless part of the experiment’s study) include:</p>
<ul>
<li>
<em>Transcriptional bursting</em>: Gene transcription is not turned on all of the time for all genes. Time of harvest will determine whether gene is on or off in each cell.</li>
<li>
<em>Varying rates of RNA processing</em>: Different RNAs are processed at different rates.</li>
<li>
<em>Continuous or discrete cell identities</em> (e.g.&nbsp;the pro-inflammatory potential of each individual T cell): Continuous phenotypes are by definition variable in gene expression, and separating the continuous from the discrete can sometimes be difficult.</li>
<li>
<em>Environmental stimuli</em>: The local environment of the cell can influence the gene expression depending on spatial position, signaling molecules, etc.</li>
<li>
<em>Temporal changes</em>: Fundamental fluxuating cellular processes, such as cell cycle, can affect the gene expression profiles of individual cells.</li>
</ul>
<p align="center">
<img src="./projects/scRNA-seq_online/img/sc_biol_variability.png" width="500"></p>
</section><section id="technical-variability-across-cellssamples" class="level4"><h4 class="anchored" data-anchor-id="technical-variability-across-cellssamples">Technical variability across cells/samples</h4>
<p>Technical sources of variation can result in gene expression between cells being more similar/different based on technical sources instead of biological cell types/states, which can obscure the cell type identities. Technical sources of variation include:</p>
<ul>
<li>
<em>Cell-specific capture efficiency</em>: Different cells will have differing numbers of transcripts captured resulting in differences in sequencing depth (e.g.&nbsp;10-50% of transcriptome).</li>
<li>
<em>Library quality</em>: Degraded RNA, low viability/dying cells, lots of free floating RNA, poorly dissociated cells, and inaccurate quantitation of cells can result in low quality metrics</li>
<li>
<em>Amplification bias</em>: During the amplification step of library preparation, not all transcripts are amplified to the same level.</li>
<li>
<em>Batch effects</em>: Batch effects are a significant issue for scRNA-Seq analyses, since you can see significant differences in expression due solely to the batch effect.</li>
</ul>
<p align="center">
<img src="./projects/scRNA-seq_online/img/batch_effect_pca.png" width="600"></p>
<p><em>How to know whether you have batches?</em></p>
<ul>
<li>Were all RNA isolations performed on the same day?</li>
<li>Were all library preparations performed on the same day?</li>
<li>Did the same person perform the RNA isolation/library preparation for all samples?</li>
<li>Did you use the same reagents for all samples?</li>
<li>Did you perform the RNA isolation/library preparation in the same location?</li>
</ul>
<p>If any of the answers is ‘No’, then you have batches.</p>
<p><em>Best practices regarding batches:</em></p>
<ul>
<li><p>Design the experiment in a way to avoid batches, if possible.</p></li>
<li>
<p>if unable to avoid batches:</p>
<ul>
<li>Do NOT confound your experiment by batch:</li>
</ul>
<p><img src="./projects/scRNA-seq_online/img/confounded_batch.png" width="300"></p>
<ul>
<li>DO split replicates of the different sample groups across batches. The more replicates the better (definitely more than 2), if doing DE across conditions or making conclusions at the population level. If using inDrops, which prepares a single library at a time, alternate the sample groups (e.g.&nbsp;don’t prepare all control libraries first, then prepare all treatment libraries).</li>
</ul>
<p><img src="./projects/scRNA-seq_online/img/batch_effect.png" width="300"></p>
<ul>
<li>DO include batch information in your experimental metadata. During the analysis, we can regress out variation due to batch or integrate across batches, so it doesn’t affect our results if we have that information.</li>
</ul>
</li>
</ul></section></section><section id="conclusions" class="level3"><h3 class="anchored" data-anchor-id="conclusions">Conclusions</h3>
<p>While scRNA-seq is a powerful and insightful method for the analysis of gene expression with single-cell resolution, there are many challenges and sources of variation that can make the analysis of the data complex or limited. Throughout the analysis of scRNA-seq data, we will try to account for or regress out variation due to the various sources of uninteresting variation in our data.</p>
<p><em>Overall, we recommend the following:</em></p>
<ul>
<li><p>Do not perform single-cell RNA-seq unless it is necessary for the experimental question of interest. Could you answer the question using bulk sequencing, which is simpler and less costly? Perhaps FACS sorting the samples could allow for bulk analysis? Understand the details of the experimental question you wish to address. The recommended library preparation method and analysis workflow can vary based on the specific experiment.</p></li>
<li>
<p>Avoid technical sources of variability, if possible:</p>
<ul>
<li>Discuss experimental design with experts prior to the initiation of the experiment</li>
<li>Isolate RNA from samples at same time</li>
<li>Prepare libraries at same time or alternate sample groups to avoid batch confounding</li>
<li>Do not confound sample groups by sex, age, or batch</li>
</ul>
</li>
</ul></section></section><section id="raw-data-to-count-matrix" class="level2"><h2 class="anchored" data-anchor-id="raw-data-to-count-matrix">Raw data to count matrix</h2>
<p>Depending on the library preparation method used, the RNA sequences (also referred to as reads or tags), will be derived either from the 3’ ends (or 5’ ends) of the transcripts (10X Genomics, CEL-seq2, Drop-seq, inDrops) or from full-length transcripts (Smart-seq).</p>
<p>The choice of method involves the biological question of interest. The following advantages are listed below for the methods:</p>
<ul>
<li>
<strong>3’ (or 5’)-end sequencing:</strong>
<ul>
<li>More accurate quantification through use of unique molecular identifiers distinguishing biological duplicates from amplification (PCR) duplicates</li>
<li>Larger number of cells sequenced allows better identity of cell type populations</li>
<li>Cheaper per cell cost</li>
<li>Best results with &gt; 10,000 cells</li>
</ul>
</li>
<li>
<strong>Full length sequencing:</strong>
<ul>
<li>Detection of isoform-level differences in expression</li>
<li>Identification of allele-specific differences in expression</li>
<li>Deeper sequencing of a smaller number of cells</li>
<li>Best for samples with low number of cells</li>
</ul>
</li>
</ul>
<p>Many of the same analysis steps need to occur for 3’-end sequencing as for full-length, but 3’ protocols have been increasing in popularity and consist of a few more steps in the analysis. Therefore, our materials are going to detail the analysis of data from these 3’ protocols with a focus on the droplet-based methods (inDrops, Drop-seq, 10X Genomics).</p>
<section id="end-reads-includes-all-droplet-based-methods" class="level3"><h3 class="anchored" data-anchor-id="end-reads-includes-all-droplet-based-methods">3’-end reads (includes all droplet-based methods)</h3>
<p>For the 3’-end sequencing methods, reads originating from different molecules of the same transcript would have originated only from the 3’ end of the transcripts, so would have a high likelihood of having the same sequence. However, the PCR step during library preparation could also generate read duplicates. To determine whether a read is a biological or technical duplicate, these methods use unique molecular identifiers, or UMIs.</p>
<ul>
<li>Reads with <strong>different UMIs</strong> mapping to the same transcript were derived from <strong>different molecules</strong> and are biological duplicates - each read should be counted.</li>
<li>Reads with the <strong>same UMI</strong> originated from the <strong>same molecule</strong> and are technical duplicates - the UMIs should be collapsed to be counted as a single read.</li>
<li>In image below, the reads for ACTB should be collapsed and counted as a single read, while the reads for ARL1 should each be counted.</li>
</ul>
<p align="center">
<img src="./projects/scRNA-seq_online/img/umis.png" width="600"></p>
<p>So we know that we need to keep track of the UMIs, but what other information do we need to properly quantify the expression in each gene in each of the cells in our samples? Regardless of droplet method, <strong>the following are required for proper quantification at the cellular level</strong>:</p>
<p align="center">
<img src="./projects/scRNA-seq_online/img/read_architecture.png" width="800"></p>
<ul>
<li>
<strong>Sample index</strong>:&nbsp;determines which sample the read originated from (red bottom arrow)
<ul>
<li>Added during library preparation - needs to be documented</li>
</ul>
</li>
<li>
<strong>Cellular barcode</strong>:&nbsp;determines which cell the read originated from (purple top arrow)
<ul>
<li>Each library preparation method has a stock of cellular barcodes used during the library preparation</li>
</ul>
</li>
<li>
<strong>Unique molecular identifier (UMI)</strong>:&nbsp;determines which transcript molecule the read originated from
<ul>
<li>The UMI will be used to collapse PCR duplicates (purple bottom arrow)</li>
</ul>
</li>
<li>
<strong>Sequencing read1</strong>:&nbsp;the Read1 sequence (red top arrow)</li>
<li>
<strong>Sequencing read2</strong>:&nbsp;the Read2 sequence (purple bottom arrow)</li>
</ul></section><section id="generation-of-count-matrix" class="level3"><h3 class="anchored" data-anchor-id="generation-of-count-matrix">Generation of count matrix</h3>
<p>We are going to start by discussing the first part of this workflow, which is generating the count matrix from the raw sequencing data. We will focus on the 3’ end sequencing used by droplet-based methods, such as inDrops, 10X Genomics, and Drop-seq.</p>
<p align="center">
<img src="./projects/scRNA-seq_online/img/sc_gen_matrix_workflow.png" width="300"></p>
<p>After sequencing, the sequencing facility will either output the raw sequencing data as <strong>BCL or FASTQ format or will generate the count matrix</strong>. If the reads are in BCL format, then we will need to convert to FASTQ format. There is a useful command-line tool called <code>bcl2fastq</code> that can easily perform this conversion.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>We do not demultiplex at this step in the workflow. You may have sequenced 6 samples, but the reads for all samples may be present all in the same BCL or FASTQ file.</p>
</div>
</div>
<p>The generation of the count matrix from the raw sequencing data will go through similar steps for many of the scRNA-seq methods.</p>
<p><img src="./projects/scRNA-seq_online/img/sc_pre-QC_workflow.png" width="800"></p>
</section></section><section id="quality-control" class="level2"><h2 class="anchored" data-anchor-id="quality-control">Quality Control</h2>
<section id="explore-the-example-dataset" class="level3"><h3 class="anchored" data-anchor-id="explore-the-example-dataset">Explore the example dataset</h3>
<p>For this workshop we will be working with a single-cell RNA-seq dataset which is part of a larger study from <a href="https://www.nature.com/articles/nbt.4042">Kang et al, 2017</a>. In this paper, the authors present a computational algorithm that harnesses genetic variation (eQTL) to determine the genetic identity of each droplet containing a single cell (singlet) and identify droplets containing two cells from different individuals (doublets).</p>
<p align="center">
<img src="./projects/scRNA-seq_online/img/kangetal_image.png" width="700"></p>
<p>The data used to test their algorithm is comprised of pooled Peripheral Blood Mononuclear Cells (PBMCs) taken from eight lupus patients, split into control and interferon beta-treated (stimulated) conditions.</p>
<p align="center">
<img src="./projects/scRNA-seq_online/img/sc_workflow_2022.jpg" width="630"></p>
<p>Each step of this workflow has its own goals and challenges. For QC of our raw count data, they include:</p>
<p><em>Goals:</em></p>
<ul>
<li>To filter the data to only include true cells that are high quality, so that when we cluster our cells it is easier to identify distinct cell type populations.</li>
<li>To identify any failed samples and either try to salvage the data or remove from analysis, in addition to, trying to understand why the sample failed.</li>
</ul>
<p><em>Challenges:</em></p>
<ul>
<li>Delineating cells that are poor quality from less complex cells.</li>
<li>Chossing appropriate thresholds for filtering, so as to keep high quality cells without removing biologically relevant cell types.</li>
</ul>
<p><em>Recommendations:</em></p>
<ul>
<li>Have a good idea of your expectations for the cell types to be present prior to performing the QC. For instance, do you expect to have low complexity cells or cells with higher levels of mitochondrial expression in your sample? If so, then we need to account for this biology when assessing the quality of our data.</li>
</ul></section><section id="generating-quality-metrics" class="level3"><h3 class="anchored" data-anchor-id="generating-quality-metrics">Generating quality metrics</h3>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"projects"</span>, <span class="st">"scRNA-seq_online"</span>, <span class="st">"data"</span>, <span class="st">"single_cell_rnaseq"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Create a Seurat object for each sample</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">file</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ctrl_raw_feature_bc_matrix"</span>, <span class="st">"stim_raw_feature_bc_matrix"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="co">## Read in 10X data for a single sample (output is a sparse matrix)</span></span>
<span>        <span class="va">seurat_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/Read10X.html">Read10X</a></span><span class="op">(</span>data.dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"/data/"</span>, <span class="va">file</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co">## Turn count matrix into a Seurat object (output is a Seurat object)</span></span>
<span>        <span class="va">seurat_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/CreateSeuratObject.html">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">seurat_data</span>, </span>
<span>                                         min.features <span class="op">=</span> <span class="fl">100</span>, </span>
<span>                                         project <span class="op">=</span> <span class="va">file</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/assign.html">assign</a></span><span class="op">(</span><span class="va">file</span>, <span class="va">seurat_obj</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## Create a merged Seurat object for multiple samples</span></span>
<span><span class="va">merged_seurat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">ctrl_raw_feature_bc_matrix</span>, </span>
<span>    y <span class="op">=</span> <span class="va">stim_raw_feature_bc_matrix</span>, </span>
<span>    add.cell.id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"ctrl"</span>, <span class="st">"stim"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Explore the metadata</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">merged_seurat</span><span class="op">@</span><span class="va">meta.data</span><span class="op">)</span></span>
<span><span class="co"># View(merged_seurat@meta.data)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are three columns of information: - orig.ident: this often contains the sample identity if known, but will default to“SeuratProject”. - nCount_RNA: number of UMIs per cell. - nFeature_RNA: number of genes detected per cell.</p>
<p>In order to create the appropriate plots for the quality control analysis, we need to calculate some additional metrics. These include:</p>
<ul>
<li>
<em>number of genes detected per UMI:</em> this metric with give us an idea of the complexity of our dataset (more genes detected per UMI, more complex our data)</li>
<li>
<em>mitochondrial ratio:</em> this metric will give us a percentage of cell reads originating from the mitochondrial genes</li>
</ul></section><section id="novelty-score" class="level3"><h3 class="anchored" data-anchor-id="novelty-score">Novelty score</h3>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Add number of genes per UMI for each cell to metadata</span></span>
<span><span class="va">merged_seurat</span><span class="op">$</span><span class="va">log10GenesPerUMI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span></span>
<span>    <span class="va">merged_seurat</span><span class="op">$</span><span class="va">nFeature_RNA</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">merged_seurat</span><span class="op">$</span><span class="va">nCount_RNA</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="mitochondrial-ratio" class="level3"><h3 class="anchored" data-anchor-id="mitochondrial-ratio">Mitochondrial Ratio</h3>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Compute percent mito ratio</span></span>
<span><span class="va">merged_seurat</span><span class="op">$</span><span class="va">mitoRatio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PercentageFeatureSet.html">PercentageFeatureSet</a></span><span class="op">(</span></span>
<span>    object <span class="op">=</span> <span class="va">merged_seurat</span>, pattern <span class="op">=</span> <span class="st">"^MT-"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">merged_seurat</span><span class="op">$</span><span class="va">mitoRatio</span> <span class="op">&lt;-</span> <span class="va">merged_seurat</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">mitoRatio</span> <span class="op">/</span> <span class="fl">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="additional-metadata-columns" class="level3"><h3 class="anchored" data-anchor-id="additional-metadata-columns">Additional metadata columns</h3>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Create metadata dataframe</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="va">merged_seurat</span><span class="op">@</span><span class="va">meta.data</span></span>
<span></span>
<span><span class="co">## Add cell IDs to metadata</span></span>
<span><span class="va">metadata</span><span class="op">$</span><span class="va">cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html">rownames</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Create sample column</span></span>
<span><span class="va">metadata</span><span class="op">$</span><span class="va">sample</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">metadata</span><span class="op">$</span><span class="va">sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">$</span><span class="va">cells</span>, <span class="st">"^ctrl_"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"ctrl"</span></span>
<span><span class="va">metadata</span><span class="op">$</span><span class="va">sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">$</span><span class="va">cells</span>, <span class="st">"^stim_"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"stim"</span></span>
<span></span>
<span><span class="co">## Rename columns</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="va">metadata</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span></span>
<span>        seq_folder <span class="op">=</span> <span class="va">orig.ident</span>,</span>
<span>        nUMI <span class="op">=</span> <span class="va">nCount_RNA</span>,</span>
<span>        nGene <span class="op">=</span> <span class="va">nFeature_RNA</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co">## Add metadata back to Seurat object</span></span>
<span><span class="va">merged_seurat</span><span class="op">@</span><span class="va">meta.data</span> <span class="op">&lt;-</span> <span class="va">metadata</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="assessing-the-quality-metrics" class="level3"><h3 class="anchored" data-anchor-id="assessing-the-quality-metrics">Assessing the quality metrics</h3>
<p>Assess various metrics and then decide on which cells are low quality and should be removed from the analysis:</p>
<ul>
<li>Cell counts</li>
<li>UMI counts per cell</li>
<li>Genes detected per cell</li>
<li>Complexity (novelty score)</li>
<li>Mitochondrial counts ratio</li>
</ul>
<section id="cell-counts" class="level4"><h4 class="anchored" data-anchor-id="cell-counts">Cell counts</h4>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Visualize the number of cell counts per sample</span></span>
<span><span class="va">metadata</span> <span class="op">|&gt;</span>  </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">sample</span>, fill<span class="op">=</span><span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, vjust <span class="op">=</span> <span class="fl">1</span>, hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span>, face<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"NCells"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="umi-counts-transcripts-per-cell" class="level4"><h4 class="anchored" data-anchor-id="umi-counts-transcripts-per-cell">UMI counts (transcripts) per cell</h4>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Visualize the number UMIs/transcripts per cell</span></span>
<span><span class="co"># metadata |&gt;  </span></span>
<span><span class="co">#       ggplot(aes(color=sample, x=nUMI, fill= sample)) + </span></span>
<span><span class="co">#       geom_density(alpha = 0.2) + </span></span>
<span><span class="co">#       scale_x_log10() + </span></span>
<span><span class="co">#       theme_classic() +</span></span>
<span><span class="co">#       ylab("Cell density") +</span></span>
<span><span class="co">#       geom_vline(xintercept = 500)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="genes-detected-per-cell" class="level3"><h3 class="anchored" data-anchor-id="genes-detected-per-cell">Genes detected per cell</h3>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Visualize the distribution of genes detected per cell via histogram</span></span>
<span><span class="co"># metadata |&gt;  </span></span>
<span><span class="co">#       ggplot(aes(color=sample, x=nGene, fill= sample)) + </span></span>
<span><span class="co">#       geom_density(alpha = 0.2) + </span></span>
<span><span class="co">#       theme_classic() +</span></span>
<span><span class="co">#       scale_x_log10() + </span></span>
<span><span class="co">#       geom_vline(xintercept = 300)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="complexity" class="level3"><h3 class="anchored" data-anchor-id="complexity">Complexity</h3>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Visualize the overall complexity of the gene expression by visualizing the genes detected per UMI (novelty score)</span></span>
<span><span class="va">metadata</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">log10GenesPerUMI</span>, color <span class="op">=</span> <span class="va">sample</span>, fill<span class="op">=</span><span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="mitochondrial-counts-ratio" class="level3"><h3 class="anchored" data-anchor-id="mitochondrial-counts-ratio">Mitochondrial counts ratio</h3>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Visualize the distribution of mitochondrial gene expression detected per cell</span></span>
<span><span class="va">metadata</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">sample</span>, x<span class="op">=</span><span class="va">mitoRatio</span>, fill<span class="op">=</span><span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="joint-filtering-effects" class="level3"><h3 class="anchored" data-anchor-id="joint-filtering-effects">Joint filtering effects</h3>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Visualize the correlation between genes detected and number of UMIs and determine whether strong presence of cells with low numbers of genes/UMIs</span></span>
<span><span class="va">metadata</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">nUMI</span>, y<span class="op">=</span><span class="va">nGene</span>, color<span class="op">=</span><span class="va">mitoRatio</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_colour_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"gray90"</span>, high <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">stat_smooth</a></span><span class="op">(</span>method<span class="op">=</span><span class="va">lm</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">500</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">250</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">sample</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="perform-filtering" class="level3"><h3 class="anchored" data-anchor-id="perform-filtering">Perform filtering</h3>
<section id="cell-level-filtering" class="level4"><h4 class="anchored" data-anchor-id="cell-level-filtering">Cell-level filtering</h4>
<p>Often the recommendations mentioned earlier are a rough guideline, and the specific experiment needs to inform the exact thresholds chosen. We will use the following thresholds:</p>
<ul>
<li>nUMI &gt; 500</li>
<li>nGene &gt; 250</li>
<li>log10GenesPerUMI &gt; 0.8</li>
<li>mitoRatio &lt; 0.2</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Filter out low quality cells using selected thresholds - these will change with experiment</span></span>
<span><span class="va">filtered_seurat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/subset.html">subset</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">merged_seurat</span>,</span>
<span>    subset <span class="op">=</span> <span class="op">(</span><span class="va">nUMI</span> <span class="op">&gt;=</span> <span class="fl">500</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>        <span class="op">(</span><span class="va">nGene</span> <span class="op">&gt;=</span> <span class="fl">250</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>        <span class="op">(</span><span class="va">log10GenesPerUMI</span> <span class="op">&gt;</span> <span class="fl">0.80</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>        <span class="op">(</span><span class="va">mitoRatio</span> <span class="op">&lt;</span> <span class="fl">0.20</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="gene-level-filtering" class="level4"><h4 class="anchored" data-anchor-id="gene-level-filtering">Gene-level filtering</h4>
<p>Within our data we will have many genes with zero counts. These genes can dramatically reduce the average expression for a cell and so we will remove them from our data. We will start by identifying which genes have a zero count in each cell:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Extract counts</span></span>
<span><span class="va">filtered_seurat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/SplitLayers.html">JoinLayers</a></span><span class="op">(</span><span class="va">filtered_seurat</span><span class="op">)</span></span>
<span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/AssayData.html">GetAssayData</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">filtered_seurat</span>, layer <span class="op">=</span> <span class="st">"counts"</span><span class="op">)</span></span>
<span><span class="co"># counts &lt;- LayerData(object = filtered_seurat, layer = "counts")</span></span>
<span></span>
<span><span class="co">## Output a logical matrix specifying for each gene on whether or not there are more than zero counts per cell</span></span>
<span><span class="va">nonzero</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op">&gt;</span> <span class="fl">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we will perform some filtering by prevalence. If a gene is only expressed in a handful of cells, it is not particularly meaningful as it still brings down the averages for all other cells it is not expressed in. For our data we choose to <em>keep only genes which are expressed in 10 or more cells</em>. By using this filter, genes which have zero counts in all cells will effectively be removed.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Sums all TRUE values and returns TRUE if more than 10 TRUE values per gene</span></span>
<span><span class="va">keep_genes</span> <span class="op">&lt;-</span> <span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">nonzero</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">10</span></span>
<span></span>
<span><span class="co"># Only keeping those genes expressed in more than 10 cells</span></span>
<span><span class="va">filtered_counts</span> <span class="op">&lt;-</span> <span class="va">counts</span><span class="op">[</span><span class="va">keep_genes</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># Reassign to filtered Seurat object</span></span>
<span><span class="va">filtered_seurat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/CreateSeuratObject.html">CreateSeuratObject</a></span><span class="op">(</span></span>
<span>    <span class="va">filtered_counts</span>, meta.data <span class="op">=</span> <span class="va">filtered_seurat</span><span class="op">@</span><span class="va">meta.data</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Save filtered cells</span></span>
<span><span class="co"># saveRDS(filtered_seurat, file = paste0(dir, "/data/filtered_seurat.rds"))</span></span>
<span><span class="co"># saveRDS(merged_seurat, file = paste0(dir, "/data/merged_seurat.rds"))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="re-assess-qc-metrics" class="level3"><h3 class="anchored" data-anchor-id="re-assess-qc-metrics">Re-assess QC metrics</h3>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Save filtered subset to new metadata</span></span>
<span><span class="va">metadata_clean</span> <span class="op">&lt;-</span> <span class="va">filtered_seurat</span><span class="op">@</span><span class="va">meta.data</span></span>
<span></span>
<span><span class="va">metadata_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    before_filtering <span class="op">=</span> <span class="va">metadata</span>,</span>
<span>    after_filtering  <span class="op">=</span> <span class="va">metadata_clean</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">metadata_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co">## Cell counts</span></span>
<span>    <span class="va">plots</span><span class="op">[[</span><span class="st">"cell_counts"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">metadata_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sample</span>, fill <span class="op">=</span> <span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, vjust <span class="op">=</span> <span class="fl">1</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html">paste</a></span><span class="op">(</span><span class="st">"NCells"</span>, <span class="va">i</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## UMI counts</span></span>
<span>    <span class="co">## The filtering using a threshold of 500 has removed the cells with low numbers of UMIs from the analysis.</span></span>
<span>    <span class="va">plots</span><span class="op">[[</span><span class="st">"UMI_counts"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">metadata_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">sample</span>, x <span class="op">=</span> <span class="va">nUMI</span>, fill <span class="op">=</span> <span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">10000</span><span class="op">)</span>, trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">500</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="co"># coord_fixed() +</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span></span>
<span>            title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html">paste</a></span><span class="op">(</span><span class="st">"UMI"</span>, <span class="va">i</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span>, </span>
<span>            y <span class="op">=</span> <span class="st">"Cell density"</span></span>
<span>        <span class="op">)</span></span>
<span>        </span>
<span>    <span class="co">## Genes detected</span></span>
<span>    <span class="va">plots</span><span class="op">[[</span><span class="st">"genes_detected"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">metadata_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">sample</span>, x <span class="op">=</span> <span class="va">nGene</span>, fill <span class="op">=</span> <span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">3000</span><span class="op">)</span>, trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">250</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="co"># coord_fixed() +</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html">paste</a></span><span class="op">(</span><span class="st">"genes_detected"</span>, <span class="va">i</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">## Novelty/Complexity</span></span>
<span>    <span class="va">plots</span><span class="op">[[</span><span class="st">"overall_complexity"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">metadata_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">log10GenesPerUMI</span>, color <span class="op">=</span> <span class="va">sample</span>, fill<span class="op">=</span><span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="co"># coord_fixed() +</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html">paste</a></span><span class="op">(</span><span class="st">"overall_complexity"</span>, <span class="va">i</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">## Mitochondrial counts ratio</span></span>
<span>    <span class="va">plots</span><span class="op">[[</span><span class="st">"mitochondrial_ratio"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">metadata_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">sample</span>, x<span class="op">=</span><span class="va">mitoRatio</span>, fill<span class="op">=</span><span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html">geom_density</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="co"># coord_fixed() +</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html">paste</a></span><span class="op">(</span><span class="st">"mitochondrial_ratio"</span>, <span class="va">i</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## UMIs vs genes</span></span>
<span>    <span class="va">plots</span><span class="op">[[</span><span class="st">"UMIs_genes"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">metadata_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">nUMI</span>, y <span class="op">=</span> <span class="va">nGene</span>, color <span class="op">=</span> <span class="va">mitoRatio</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_colour_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"gray90"</span>, high <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">stat_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="va">lm</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="co"># coord_fixed() +</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">500</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">250</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">sample</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/paste.html">paste</a></span><span class="op">(</span><span class="st">"UMIs_genes"</span>, <span class="va">i</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Report the number of cells left for each sample, and comment on whether the number of cells removed is high or low. Can you give reasons why this number is still not ~12K (which is how many cells were loaded for the experiment)?</strong></p>
<p>After filtering, we should not have more cells than we sequenced. Generally we aim to have about the number we sequenced or a bit less.</p>
<p>There are just under 15K cells left for both the control and stim cells. The number of cells removed is reasonably low.</p>
<p>While it would be ideal to have 12K cells, we do not expect that due to:</p>
<ul>
<li>barcoded beads in the droplet with no actual cell present</li>
<li>more than one barcode in the droplet; results in a single cell’s mRNA represented as two cells</li>
<li>dead or dying cells encapsulated into the droplet</li>
</ul>
<p>If we still see higher than expected numbers of cells after filtering, this means we could afford to filter more stringently (but we don’t necessarily have to).</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span><span class="op">(</span><span class="va">plots</span><span class="op">$</span><span class="va">cell_counts</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Get the min and max values from the ranges</span></span>
<span><span class="va">p_ranges_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot_build.html">ggplot_build</a></span><span class="op">(</span><span class="va">p_combined</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">layout</span><span class="op">$</span><span class="va">panel_scales_x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">range</span><span class="op">$</span><span class="va">range</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot_build.html">ggplot_build</a></span><span class="op">(</span><span class="va">p_combined</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">layout</span><span class="op">$</span><span class="va">panel_scales_x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">range</span><span class="op">$</span><span class="va">range</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_ranges_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot_build.html">ggplot_build</a></span><span class="op">(</span><span class="va">p_combined</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">layout</span><span class="op">$</span><span class="va">panel_scales_y</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">range</span><span class="op">$</span><span class="va">range</span>,</span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot_build.html">ggplot_build</a></span><span class="op">(</span><span class="va">p_combined</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">layout</span><span class="op">$</span><span class="va">panel_scales_y</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">range</span><span class="op">$</span><span class="va">range</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Apply these ranges to the patchwork object</span></span>
<span><span class="va">p_combined</span> <span class="op">&amp;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">p_ranges_x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">p_ranges_x</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">p_ranges_y</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">p_ranges_y</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span><span class="op">(</span><span class="va">plots</span><span class="op">$</span><span class="va">UMI_counts</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>After filtering for nGene per cell, you should still observe a small shoulder to the right of the main peak. What might this shoulder represent?</strong></p>
<p>This peak could represent a biologically distinct population of cells. It could be a set a of cells that share some properties and as a consequence exhibit more diversity in its transcriptome (with the larger number of genes detected).</p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## The filtering using a threshold of 500 has removed the cells with low numbers of UMIs from the analysis.</span></span>
<span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span><span class="op">(</span><span class="va">plots</span><span class="op">$</span><span class="va">genes_detected</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>When plotting the nGene against nUMI do you observe any data points in the bottom right quadrant of the plot? What can you say about these cells that have been removed?</strong></p>
<p>The cells that were removed were those with high nUMI but low numbers of genes detected. These cells had many captured transcripts but represent only a small number of genes. These low complexity cells could represent a specific cell type (i.e.&nbsp;red blood cells which lack a typical transcriptome), or could be due to some other strange artifact or contamination.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span><span class="op">(</span><span class="va">plots</span><span class="op">$</span><span class="va">UMIs_genes</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span><span class="op">(</span><span class="va">plots</span><span class="op">$</span><span class="va">mitochondrial_ratio</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span><span class="op">(</span><span class="va">plots</span><span class="op">$</span><span class="va">overall_complexity</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="normalization" class="level2"><h2 class="anchored" data-anchor-id="normalization">Normalization</h2>
<p><em>Goals:</em></p>
<ul>
<li>To accurately normalize the gene expression values to account for differences in sequencing depth and overdispersed count values.</li>
<li>To identify the most variant genes likely to be indicative of the different cell types present.</li>
</ul>
<p><em>Challenges:</em></p>
<ul>
<li>Checking and removing unwanted variation so that we do not have cells clustering by artifacts downstream</li>
</ul>
<p><em>Recommendations:</em></p>
<ul>
<li>Have a good idea of your expectations for the cell types to be present prior to performing the clustering. Know whether you expect cell types of low complexity or higher mitochondrial content AND whether the cells are differentiating</li>
<li>Regress out number of UMIs (default using sctransform), mitochondrial content, and cell cycle, if needed and appropriate for experiment, so not to drive clustering downstream</li>
</ul>
<p>An essential first step in the majority of mRNA expression analyses is normalization, whereby systematic variations are adjusted for to <strong>make expression counts comparable across genes and/or samples</strong>. The counts of mapped reads for each gene is proportional to the expression of RNA (“interesting”) in addition to many other factors (“uninteresting”). Normalization is the process of adjusting raw count values to account for the “uninteresting” factors.</p>
<p>The main factors often considered during normalization are:</p>
<ul>
<li>
<strong>Sequencing depth:</strong> Accounting for sequencing depth is necessary for comparison of gene expression between cells. In the example below, each gene appears to have doubled in expression in cell 2, however this is a consequence of cell 2 having twice the sequencing depth.</li>
</ul>
<p align="center">
<img src="./projects/scRNA-seq_online/img/sequencing_depth.png" width="400"></p>
<p>Each cell in scRNA-seq will have a differing number of reads associated with it. So to accurately compare expression between cells, it is necessary to normalize for sequencing depth.</p>
<ul>
<li>
<strong>Gene length:</strong> Accounting for gene length is necessary for comparing expression between different genes within the same cell. The number of reads mapped to a longer gene can appear to have equal count/expression as a shorter gene that is more highly expressed.</li>
</ul>
<p align="center">
<img src="./projects/scRNA-seq_online/img/length_of_gene.png" width="400"></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><em>If using a 3’ or 5’ droplet-based method, the length of the gene will not affect the analysis because only the 5’ or 3’ end of the transcript is sequenced.</em> However, if using full-length sequencing, the transcript length should be accounted for.</p>
</div>
</div>
<section id="explore-sources-of-unwanted-variation" class="level3"><h3 class="anchored" data-anchor-id="explore-sources-of-unwanted-variation">Explore sources of unwanted variation</h3>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Normalize the counts</span></span>
<span><span class="va">filtered_seurat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"/data/filtered_seurat.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">seurat_phase</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html">NormalizeData</a></span><span class="op">(</span><span class="va">filtered_seurat</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="evaluating-effects-of-cell-cycle" class="level4"><h4 class="anchored" data-anchor-id="evaluating-effects-of-cell-cycle">Evaluating effects of cell cycle</h4>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Load cell cycle markers</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">dir</span>, <span class="st">"/data/cycle.rda"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">g2m_genes</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">s_genes</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Score cells for cell cycle</span></span>
<span><span class="va">seurat_phase</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/CellCycleScoring.html">CellCycleScoring</a></span><span class="op">(</span></span>
<span>    <span class="va">seurat_phase</span>,</span>
<span>    g2m.features <span class="op">=</span> <span class="va">g2m_genes</span>,</span>
<span>    s.features <span class="op">=</span> <span class="va">s_genes</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## View cell cycle scores and phases assigned to cells                                 </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">seurat_phase</span><span class="op">@</span><span class="va">meta.data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After scoring the cells for cell cycle, we would like to <strong>determine whether cell cycle is a major source of variation in our dataset using PCA</strong>.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Identify the most variable genes</span></span>
<span><span class="va">seurat_phase</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html">FindVariableFeatures</a></span><span class="op">(</span></span>
<span>    <span class="va">seurat_phase</span>, </span>
<span>    selection.method <span class="op">=</span> <span class="st">"vst"</span>,</span>
<span>    nfeatures <span class="op">=</span> <span class="fl">2000</span>, </span>
<span>    verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Scale the counts</span></span>
<span><span class="va">seurat_phase</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html">ScaleData</a></span><span class="op">(</span><span class="va">seurat_phase</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Identify the 15 most highly variable genes</span></span>
<span><span class="va">ranked_variable_genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/VariableFeatures.html">VariableFeatures</a></span><span class="op">(</span><span class="va">seurat_phase</span><span class="op">)</span></span>
<span><span class="va">top_genes</span> <span class="op">&lt;-</span> <span class="va">ranked_variable_genes</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">15</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## Plot the average expression and variance of these genes</span></span>
<span><span class="co">## With labels to indicate which genes are in the top 15</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/VariableFeaturePlot.html">VariableFeaturePlot</a></span><span class="op">(</span><span class="va">seurat_phase</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/LabelPoints.html">LabelPoints</a></span><span class="op">(</span>plot <span class="op">=</span> <span class="va">p</span>, points <span class="op">=</span> <span class="va">top_genes</span>, repel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Perform PCA</span></span>
<span><span class="va">seurat_phase</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html">RunPCA</a></span><span class="op">(</span><span class="va">seurat_phase</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Plot the PCA colored by cell cycle phase</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span></span>
<span>    <span class="va">seurat_phase</span>,</span>
<span>    reduction <span class="op">=</span> <span class="st">"pca"</span>,</span>
<span>    group.by<span class="op">=</span> <span class="st">"Phase"</span>,</span>
<span>    split.by <span class="op">=</span> <span class="st">"Phase"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We do not see large differences due to cell cycle phase. Based on this plot, we would not regress out the variation due to cell cycle.</p>
</section><section id="evaluating-effects-of-mitochondrial-expression" class="level4"><h4 class="anchored" data-anchor-id="evaluating-effects-of-mitochondrial-expression">Evaluating effects of mitochondrial expression</h4>
<p>Mitochondrial expression is another factor which can greatly influence clustering. Oftentimes, it is useful to regress out variation due to mitochondrial expression. However, if the differences in mitochondrial gene expression represent a biological phenomenon that may help to distinguish cell clusters, then we advise not regressing this out. In this exercise, we can perform a quick check similar to looking at cell cycle and decide whether or not we want to regress it out.</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Check quartile values</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">seurat_phase</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">mitoRatio</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Turn mitoRatio into categorical factor vector based on quartile values</span></span>
<span><span class="va">seurat_phase</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">mitoFr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span></span>
<span>    <span class="va">seurat_phase</span><span class="op">@</span><span class="va">meta.data</span><span class="op">$</span><span class="va">mitoRatio</span>,</span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0.0144</span>, <span class="fl">0.0199</span>, <span class="fl">0.0267</span>, <span class="cn">Inf</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Low"</span>, <span class="st">"Medium"</span>, <span class="st">"Medium high"</span>, <span class="st">"High"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Plot the PCA colored by mitoFr</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span></span>
<span>    <span class="va">seurat_phase</span>,</span>
<span>    reduction <span class="op">=</span> <span class="st">"pca"</span>,</span>
<span>    group.by <span class="op">=</span> <span class="st">"mitoFr"</span>,</span>
<span>    split.by <span class="op">=</span> <span class="st">"mitoFr"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Based on this plot, we can see that there is a different pattern of scatter for the plot containing cells with “High” mitochondrial expression. We observe that the lobe of cells on the left-hand side of the plot is where most of the cells with high mitochondrial expression are. For all other levels of mitochondrial expression we see a more even distribution of cells across the PCA plot.</p>
<p><strong>Would you regress out mitochndrial fraction as a source of unwanted variation?</strong></p>
<p>Since we see this clear difference, we will regress out the ‘mitoRatio’ when we identify the most variant genes.</p>
</section></section><section id="normalization-and-regressing-out-sources-of-unwanted-variation-using-sctransform" class="level3"><h3 class="anchored" data-anchor-id="normalization-and-regressing-out-sources-of-unwanted-variation-using-sctransform">Normalization and regressing out sources of unwanted variation using SCTransform</h3>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Split seurat object by condition to perform cell cycle scoring and SCT on all samples</span></span>
<span><span class="va">split_seurat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SplitObject.html">SplitObject</a></span><span class="op">(</span><span class="va">seurat_phase</span>, split.by <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## keep them as separate objects and transform them as that is what is required for integration</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">split_seurat</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">split_seurat</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SCTransform.html">SCTransform</a></span><span class="op">(</span></span>
<span>        <span class="va">split_seurat</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, vars.to.regress <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mitoRatio"</span><span class="op">)</span>, vst.flavor <span class="op">=</span> <span class="st">"v2"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## Check which assays are stored in objects</span></span>
<span><span class="va">split_seurat</span><span class="op">$</span><span class="va">ctrl</span><span class="op">@</span><span class="va">assays</span></span>
<span><span class="va">split_seurat</span><span class="op">$</span><span class="va">stim</span><span class="op">@</span><span class="va">assays</span></span>
<span></span>
<span><span class="co">## Save the split seurat object</span></span>
<span><span class="co"># saveRDS(split_seurat, paste0(dir, "/data/split_seurat.rds"))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Any observations for the genes or features listed under <em>“First 10 features:”</em> and the <em>“Top 10 variable features:”</em> for “ctrl” versus “stim”?</strong></p>
<p>For the first 10 features, it appears that the same genes are present in both “ctrl” and “stim”</p>
<p>For the top 10 variable features, these are different in the the 2 conditions with some overlap between them.</p>
</section></section><section id="integration" class="level2"><h2 class="anchored" data-anchor-id="integration">Integration</h2>
<p><em>Goals:</em></p>
<ul>
<li>To align same cell types across conditions.</li>
</ul>
<p><em>Challenges:</em></p>
<ul>
<li>Aligning cells of similar cell types so that we do not have clustering downstream due to differences between samples, conditions, modalities, or batches</li>
</ul>
<p><em>Recommendations:</em></p>
<ul>
<li>Go through the analysis without integration first to determine whether integration is necessary</li>
</ul>
<section id="to-integrate-or-not-to-integrate" class="level3"><h3 class="anchored" data-anchor-id="to-integrate-or-not-to-integrate">To integrate or not to integrate?</h3>
<p>Generally, we always look at our clustering <strong>without integration</strong> before deciding whether we need to perform any alignment. <strong>Do not just always perform integration because you think there might be differences - explore the data.</strong> If we had performed the normalization on both conditions together in a Seurat object and visualized the similarity between cells, we would have seen condition-specific clustering:</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Run UMAP</span></span>
<span><span class="va">seurat_phase</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span></span>
<span>    <span class="va">seurat_phase</span>,</span>
<span>    dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">40</span>,reduction <span class="op">=</span> <span class="st">"pca"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Plot UMAP</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">seurat_phase</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Condition-specific clustering of the cells indicates that we need to integrate the cells across conditions to ensure that cells of the same cell type cluster together.</p>
<p><strong>Why is it important the cells of the same cell type cluster together?</strong></p>
<p>We want to identify <em><strong>cell types which are present in all samples/conditions/modalities</strong></em> within our dataset, and therefore would like to observe a representation of cells from both samples/conditions/modalities in every cluster. This will enable more interpretable results downstream (i.e.&nbsp;DE analysis, ligand-receptor analysis, differential abundance analysis…).</p>
</section><section id="integrate-or-align-samples-across-conditions-using-shared-highly-variable-genes" class="level3"><h3 class="anchored" data-anchor-id="integrate-or-align-samples-across-conditions-using-shared-highly-variable-genes">Integrate or align samples across conditions using shared highly variable genes</h3>
<p><strong>If cells cluster by sample, condition, batch, dataset, modality, this integration step can greatly improve the clustering and the downstream analyses</strong>.</p>
<p>To integrate, we will use the shared highly variable genes (identified using SCTransform) from each group, then, we will “integrate” or “harmonize” the groups to overlay cells that are similar or have a “common set of biological features” between groups.</p>
<p>Integration is a powerful method that uses these shared sources of greatest variation to identify shared subpopulations across conditions or datasets [Stuart and Bulter et al.&nbsp;(2018)]. The goal of integration is to ensure that the cell types of one condition/dataset align with the same celltypes of the other conditions/datasets (e.g.&nbsp;control macrophages align with stimulated macrophages).</p>
</section><section id="integration-using-cca" class="level3"><h3 class="anchored" data-anchor-id="integration-using-cca">Integration using CCA</h3>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Select the most variable features to use for integration</span></span>
<span><span class="va">integ_features</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SelectIntegrationFeatures.html">SelectIntegrationFeatures</a></span><span class="op">(</span></span>
<span>    object.list <span class="op">=</span> <span class="va">split_seurat</span>, </span>
<span>    nfeatures <span class="op">=</span> <span class="fl">3000</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Prepare the SCT list object for integration</span></span>
<span><span class="va">split_seurat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/PrepSCTIntegration.html">PrepSCTIntegration</a></span><span class="op">(</span></span>
<span>    object.list <span class="op">=</span> <span class="va">split_seurat</span>, </span>
<span>    anchor.features <span class="op">=</span> <span class="va">integ_features</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Find the best buddies or anchors and filter incorrect anchors</span></span>
<span><span class="va">integ_anchors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindIntegrationAnchors.html">FindIntegrationAnchors</a></span><span class="op">(</span></span>
<span>    object.list <span class="op">=</span> <span class="va">split_seurat</span>, </span>
<span>    normalization.method <span class="op">=</span> <span class="st">"SCT"</span>, </span>
<span>    anchor.features <span class="op">=</span> <span class="va">integ_features</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Perform CCA to integrate across conditions</span></span>
<span><span class="va">seurat_integrated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/IntegrateData.html">IntegrateData</a></span><span class="op">(</span></span>
<span>    anchorset <span class="op">=</span> <span class="va">integ_anchors</span>, </span>
<span>    normalization.method <span class="op">=</span> <span class="st">"SCT"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After integration, to visualize the integrated data we can use dimensionality reduction techniques, such as PCA and Uniform Manifold Approximation and Projection (UMAP). While PCA will determine all PCs, we can only plot two at a time. In contrast, UMAP will take the information from any number of top PCs to arrange the cells in this multidimensional space. It will take those distances in multidimensional space and plot them in two dimensions working to preserve local and global structure. In this way, the distances between cells represent similarity in expression.</p>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Run PCA</span></span>
<span><span class="va">seurat_integrated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html">RunPCA</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">seurat_integrated</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Plot PCA</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">PCAPlot</a></span><span class="op">(</span><span class="va">seurat_integrated</span>, split.by <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Run UMAP</span></span>
<span><span class="va">seurat_integrated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span><span class="va">seurat_integrated</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">40</span>, reduction <span class="op">=</span> <span class="st">"pca"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Plot UMAP                             </span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">seurat_integrated</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Save integrated seurat object</span></span>
<span><span class="co"># saveRDS(seurat_integrated, paste0(dir, "/data/integrated_seurat.rds"))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="clustering" class="level2"><h2 class="anchored" data-anchor-id="clustering">Clustering</h2>
<p><strong>Goals:</strong></p>
<ul>
<li>To <strong>generate cell type-specific clusters</strong> and use known cell type marker genes to determine the identities of the clusters.</li>
<li>To <strong>determine whether clusters represent true cell types or cluster due to biological or technical variation</strong>, such as clusters of cells in the S phase of the cell cycle, clusters of specific batches, or cells with high mitochondrial content.</li>
</ul>
<p><strong>Challenges:</strong></p>
<ul>
<li>
<strong>Identifying poor quality clusters</strong> that may be due to uninteresting biological or technical variation</li>
<li>
<strong>Identifying the cell types</strong> of each cluster</li>
<li>Maintaining patience as this can be a highly iterative process between clustering and marker identification (sometimes even going back to the QC filtering)</li>
</ul>
<p><strong>Recommendations:</strong></p>
<ul>
<li>Have a good idea of your expectations for the <strong>cell types to be present</strong> prior to performing the clustering. Know whether you expect cell types of low complexity or higher mitochondrial content AND whether the cells are differentiating</li>
<li>If you have <strong>more than one condition</strong>, it’s often helpful to perform integration to align the cells</li>
<li>
<strong>Regress out</strong> number of UMIs (by default with sctransform), mitochondrial content, and cell cycle, if needed and appropriate for experiment, so not to drive clustering</li>
<li>Identify any junk clusters for removal or re-visit QC filtering. Possible junk clusters could include those with high <strong>mitochondrial content</strong> and low UMIs/genes. If comprised of a lot of cells, then may be helpful to go back to QC to filter out, then re-integrate/cluster.</li>
<li>_If <strong>not detecting all cell types as separate clusters</strong>, try changing the resolution or the number of PCs used for clustering</li>
</ul>
<section id="clustering-cells-based-on-top-pcs-metagenes" class="level3"><h3 class="anchored" data-anchor-id="clustering-cells-based-on-top-pcs-metagenes">Clustering cells based on top PCs (metagenes)</h3>
<section id="identify-significant-pcs" class="level4"><h4 class="anchored" data-anchor-id="identify-significant-pcs">Identify significant PCs</h4>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Explore heatmap of PCs</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimHeatmap.html">DimHeatmap</a></span><span class="op">(</span><span class="va">seurat_integrated</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">9</span>, cells <span class="op">=</span> <span class="fl">500</span>, balanced <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Printing out the most variable genes driving PCs</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">seurat_integrated</span><span class="op">[[</span><span class="st">"pca"</span><span class="op">]</span><span class="op">]</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, nfeatures <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Plot the elbow plot</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/ElbowPlot.html">ElbowPlot</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">seurat_integrated</span>, ndims <span class="op">=</span> <span class="fl">40</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="cluster-the-cells" class="level4"><h4 class="anchored" data-anchor-id="cluster-the-cells">Cluster the cells</h4>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">## Determine the K-nearest neighbor graph</span></span>
<span><span class="va">seurat_integrated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html">FindNeighbors</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">seurat_integrated</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">40</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Determine the clusters for various resolutions                                </span></span>
<span><span class="va">seurat_integrated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html">FindClusters</a></span><span class="op">(</span></span>
<span>    object <span class="op">=</span> <span class="va">seurat_integrated</span>,</span>
<span>    resolution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.6</span>, <span class="fl">0.8</span>, <span class="fl">1.0</span>, <span class="fl">1.4</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Explore resolutions</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">seurat_integrated</span><span class="op">@</span><span class="va">meta.data</span><span class="op">[</span>, <span class="fl">14</span><span class="op">:</span><span class="fl">20</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Assign identity of clusters</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/Idents.html">Idents</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">seurat_integrated</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"integrated_snn_res.0.8"</span></span>
<span><span class="co"># Plot the UMAP</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html">DimPlot</a></span><span class="op">(</span><span class="va">seurat_integrated</span>, reduction <span class="op">=</span> <span class="st">"umap"</span>, label <span class="op">=</span> <span class="cn">TRUE</span>, label.size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Assign identity of clusters</span></span>
<span><span class="co"># Idents(object = seurat_integrated) &lt;- "integrated_snn_res.0.4"</span></span>
<span><span class="co"># Plot the UMAP</span></span>
<span><span class="co"># DimPlot(seurat_integrated, reduction = "umap", label = TRUE, label.size = 6)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="exploration-of-quality-control-metrics" class="level3"><h3 class="anchored" data-anchor-id="exploration-of-quality-control-metrics">Exploration of quality control metrics</h3>
</section></section><section id="session-info" class="level2"><h2 class="anchored" data-anchor-id="session-info">Session Info</h2>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/grgrzhong\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p><span class="faux-block"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> 2021-2024 Guorui Zhong ~ Made with <a href="https://www.r-project.org/"><i class="fa-brands fa-r-project" aria-label="r-project"></i></a> and <a href="https://quarto.org/">Quarto</a></span></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


</body></html>