<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Guorui Zhong">
<title>Bulk RNA-seq | From reads to DEGs – Guorui Zhong</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<script src="../../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting-12b3df05fff64bd15c9bad32e15a2ea0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap-fa8806f0f1fe2c4c07c0086bb395541c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/all.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-contrib/fontawesome6-0.1.0/latex-fontsize.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>

      .quarto-title-block .quarto-title-banner {
        background: #212529;
      }
</style>
</head>
<body class="floating nav-fixed slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../../../../index.html">
    <span class="navbar-title">Guorui Zhong</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link" href="../../../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../wiki/index.html"> 
<span class="menu-text">Wiki</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../programming/linux/index.html"> 
<span class="menu-text">Linux</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../programming/python/index.html"> 
<span class="menu-text">Python</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../programming/r/index.html"> 
<span class="menu-text">R</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../keyboard/index.html"> 
<span class="menu-text">Keyboard</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Bulk RNA-seq | From reads to DEGs</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">NGS</div>
                <div class="quarto-category">RNA-seq</div>
                <div class="quarto-category">scRNA-seq</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://grgrzhong.github.io/">Guorui Zhong</a> <a href="https://orcid.org/0000-0002-1955-2847" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Monday, July 28, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Contents</h2>
   
  <ul>
<li>
<a href="#experimental-design" id="toc-experimental-design" class="nav-link active" data-scroll-target="#experimental-design">Experimental design</a>
  <ul class="collapse">
<li><a href="#replicates" id="toc-replicates" class="nav-link" data-scroll-target="#replicates">Replicates</a></li>
  <li><a href="#confounding" id="toc-confounding" class="nav-link" data-scroll-target="#confounding">Confounding</a></li>
  <li><a href="#batch-effects" id="toc-batch-effects" class="nav-link" data-scroll-target="#batch-effects">Batch effects</a></li>
  </ul>
</li>
  <li>
<a href="#overall-workflow" id="toc-overall-workflow" class="nav-link" data-scroll-target="#overall-workflow">Overall Workflow</a>
  <ul class="collapse">
<li><a href="#rna-extraction-and-library-preparation" id="toc-rna-extraction-and-library-preparation" class="nav-link" data-scroll-target="#rna-extraction-and-library-preparation">1. RNA extraction and library preparation</a></li>
  <li><a href="#sequencing---illumina" id="toc-sequencing---illumina" class="nav-link" data-scroll-target="#sequencing---illumina">2. Sequencing - Illumina</a></li>
  </ul>
</li>
  <li>
<a href="#counting-reads" id="toc-counting-reads" class="nav-link" data-scroll-target="#counting-reads">Counting reads</a>
  <ul class="collapse">
<li><a href="#quality-control-of-raw-reads" id="toc-quality-control-of-raw-reads" class="nav-link" data-scroll-target="#quality-control-of-raw-reads">1. Quality control of raw reads</a></li>
  <li><a href="#quantify-expression" id="toc-quantify-expression" class="nav-link" data-scroll-target="#quantify-expression">2. Quantify expression</a></li>
  </ul>
</li>
  <li>
<a href="#normalization" id="toc-normalization" class="nav-link" data-scroll-target="#normalization">Normalization</a>
  <ul class="collapse">
<li><a href="#deseq2-normalized-counts-median-of-ratios-method" id="toc-deseq2-normalized-counts-median-of-ratios-method" class="nav-link" data-scroll-target="#deseq2-normalized-counts-median-of-ratios-method">DESeq2-normalized counts: Median of ratios method</a></li>
  </ul>
</li>
  <li>
<a href="#count-normalization-of-mov10-dataset-using-deseq2" id="toc-count-normalization-of-mov10-dataset-using-deseq2" class="nav-link" data-scroll-target="#count-normalization-of-mov10-dataset-using-deseq2">Count normalization of Mov10 dataset using DESeq2</a>
  <ul class="collapse">
<li><a href="#match-the-metadata-and-counts-data" id="toc-match-the-metadata-and-counts-data" class="nav-link" data-scroll-target="#match-the-metadata-and-counts-data">1. Match the metadata and counts data</a></li>
  <li><a href="#create-deseq2-object" id="toc-create-deseq2-object" class="nav-link" data-scroll-target="#create-deseq2-object">2. Create DESEq2 object</a></li>
  <li><a href="#generate-the-mov10-normalized-counts" id="toc-generate-the-mov10-normalized-counts" class="nav-link" data-scroll-target="#generate-the-mov10-normalized-counts">3. Generate the Mov10 normalized counts</a></li>
  </ul>
</li>
  <li><a href="#deg-analysis-tools" id="toc-deg-analysis-tools" class="nav-link" data-scroll-target="#deg-analysis-tools">DEG Analysis Tools</a></li>
  <li><a href="#bulk-rna-seq-vs-single-cell-rna-seq" id="toc-bulk-rna-seq-vs-single-cell-rna-seq" class="nav-link" data-scroll-target="#bulk-rna-seq-vs-single-cell-rna-seq">Bulk RNA-seq vs Single-Cell RNA-seq</a></li>
  <li><a href="#single-cell-rna-seq" id="toc-single-cell-rna-seq" class="nav-link" data-scroll-target="#single-cell-rna-seq">Single-Cell RNA-seq</a></li>
  <li><a href="#reference" id="toc-reference" class="nav-link" data-scroll-target="#reference">Reference</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content"><section id="experimental-design" class="level2"><h2 class="anchored" data-anchor-id="experimental-design">Experimental design</h2>
<ol type="1">
<li>Number and type of replicates</li>
<li>Avoiding confounding factors</li>
<li>Addressing batch effects</li>
</ol>
<section id="replicates" class="level3"><h3 class="anchored" data-anchor-id="replicates">Replicates</h3>
<ul>
<li>Technical replicates: use the same biological sample to repeat the technical or experimental steps in order to accurately measure technical variation and remove it during analysis.</li>
<li>Biological replicates: use different biological samples of the same condition to measure the biological variation between samples.</li>
</ul>
<p><img src="replicates.png" class="img-fluid"></p>
<div class="callout-Note">
<ul>
<li>With the current RNA-seq technologies, technical variation is minimal, so technical replicates are generally not necessary.</li>
<li>In contrast, biological variation can be substantial, so biological replicates are essential for robust statistical analysis.</li>
<li>For differential expression analysis, the more biological replicates, the better the estimates of biological variation and the more precise our estimates of the mean expression levels.</li>
<li>Biological replicates are of greater importance than sequencing depth</li>
</ul>
</div>
<p><img src="de_replicates_img2.png" width="300"></p>
<ul>
<li>General gene-level differntial expression:
<ul>
<li>30M reads per sample for single-end reads</li>
<li>15M reads per sample if replicates &gt;=3</li>
<li>Length of reads: &gt;=50-100bp</li>
</ul>
</li>
<li>lowly expressed gene-level differntial expression:
<ul>
<li>30-60M reads</li>
<li>Length of reads: &gt;=50bp</li>
</ul>
</li>
<li>Isoform-level differntial expression:
<ul>
<li>Known isoforms, at least &gt;=30M reads per sample and paired-end reads</li>
<li>Novel isoforms, at least &gt;=60M reads per sample and paired-end reads</li>
<li>Length of reads: &gt;=50bp paired-end reads</li>
</ul>
</li>
</ul></section><section id="confounding" class="level3"><h3 class="anchored" data-anchor-id="confounding">Confounding</h3>
<p>A confounded RNA-seq experiment is one where you <strong>cannot distinguish the separate effects of two different sources of variation</strong> in the data.</p>
<p>For example, we know that sex has large effects on gene expression, and if all of our <em>control</em> mice were female and all of the <em>treatment</em> mice were male, then our treatment effect would be confounded by sex. <strong>We could not differentiate the effect of treatment from the effect of sex.</strong></p>
<p><img src="confounded_design.png" width="500"></p>
<p><strong>To AVOID confounding:</strong></p>
<ul>
<li><p>Ensure animals in each condition are all the <strong>same sex, age, litter, and batch</strong>, if possible.</p></li>
<li><p>If not possible, then ensure to split the animals equally between conditions</p></li>
</ul>
<p><img src="non_confounded_design.png" width="500"></p>
</section><section id="batch-effects" class="level3"><h3 class="anchored" data-anchor-id="batch-effects">Batch effects</h3>
<p>Batch effects are a significant issue for RNA-seq analyses, since you can see significant differences in expression due solely to the batch effect.</p>
<p><img src="batch_effect_pca.png" width="500"></p>
<p><strong>How to know whether you have batches?</strong></p>
<ul>
<li><p>Were all RNA isolations performed on the same day?</p></li>
<li><p>Were all library preparations performed on the same day?</p></li>
<li><p>Did the same person perform the RNA isolation/library preparation for all samples?</p></li>
<li><p>Did you use the same reagents for all samples?</p></li>
<li><p>Did you perform the RNA isolation/library preparation in the same location?</p></li>
</ul>
<p>If <em>any</em> of the answers is <strong>‘No’</strong>, then you have batches.</p>
<p><strong>Best practices regarding batches:</strong></p>
<ul>
<li><p>Design the experiment in a way to <strong>avoid batches</strong>, if possible.</p></li>
<li>
<p>If unable to avoid batches:</p>
<ul>
<li>
<strong>Do NOT confound</strong> your experiment by batch:</li>
</ul>
</li>
</ul>
<p><img src="confounded_batch.png" width="300"></p>
<ul>
<li>
<p><strong>DO</strong> split replicates of the different sample groups across batches. The more replicates, the better (definitely more than 2).</p>
<p><img src="batch_effect.png" width="300"></p>
</li>
<li><p><strong>DO</strong> include batch information in your <strong>experimental metadata</strong>. During the analysis, we can regress out the variation due to batch if not confounded so it doesn’t affect our results – if we have that information.</p></li>
</ul>
<p><img src="metadata_batch.png" width="300"></p>
</section></section><section id="overall-workflow" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="overall-workflow">Overall Workflow</h2>
<ul>
<li>Sequencing depth: total number of reads sequenced for a sample</li>
<li>Read length: number of base pairs in each read</li>
<li>Coverage: average number of reads that align to, or “cover,” each base in a reference sequence</li>
</ul>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="counts-workflow.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">RNA-seq Workflow</figcaption></figure>
</div>
<section id="rna-extraction-and-library-preparation" class="level3"><h3 class="anchored" data-anchor-id="rna-extraction-and-library-preparation">1. RNA extraction and library preparation</h3>
<ul>
<li>Enriching for RNA: DNAse to remove any contaminating DNA -&gt; rRNA depletion or polyA selection.
<ul>
<li>Generally, ribosomal RNA represents the majority of the RNAs present in a cell, while messenger RNAs represent a small percentage of total RNA (~2% in humans).</li>
<li>Therefore, if we want to study the protein-coding genes, we need to enrich for mRNA or deplete the rRNA.</li>
<li>For differential gene expression analysis, it is best to enrich for Poly(A)+, unless you are aiming to obtain information about long non-coding RNAs, in which case ribosomal RNA depletion is recommended.</li>
</ul>
</li>
<li>RNA quality check: check for the RNA integrity prior to starting the cDNA library preparation.
<ul>
<li>Inspection of the ribosomal RNA bands via gel electrophoresis</li>
<li>Agilent Bioanalyzer -&gt; RIN (RNA Integrity Number) -&gt; provides a means by which RNA quality from different sources can be compared.</li>
</ul>
</li>
<li>Fragmentation and size selection
<ul>
<li>Chemical, enzymatic (e.g., RNAses), or physical process</li>
<li>Size selection to retain only those fragments that Illumina sequencing machines can handle</li>
<li>~150-300bp</li>
</ul>
</li>
<li>Reverse transcribe RNA into double-stranded cDNA
<ul>
<li>Most commonly used method incorporates deoxy-UTP (dUTP) during second strand synthesis</li>
<li>Add sequence adapters to the ends of the cDNA fragments</li>
</ul>
</li>
<li>PCR amplification
<ul>
<li>Run as few amplication cycles as possible to avoid PCR artefacets.</li>
</ul>
</li>
</ul>
<p><a href="library_prep.png"></a></p>
</section><section id="sequencing---illumina" class="level3"><h3 class="anchored" data-anchor-id="sequencing---illumina">2. Sequencing - Illumina</h3>
<ul>
<li>Sequencing of the cDNA libraries will generate reads
<ul>
<li>SE-Single end dataset -&gt; Only Read1</li>
<li>PE-Paired end dataset -&gt; Read1 + Read2</li>
</ul>
</li>
<li>Sequencing by synthesis**
<ul>
<li>Cluster growth: Number of clusters ~= Number of reads</li>
<li>Sequencing</li>
<li>Image acquisition</li>
<li>Base calling: Number of sequencing cycles = Lengtßh of reads</li>
</ul>
</li>
</ul>
<p><a href="illumina_sequencing_process.png"></a></p>
</section></section><section id="counting-reads" class="level2"><h2 class="anchored" data-anchor-id="counting-reads">Counting reads</h2>
<p>Count normalization is</p>
<section id="quality-control-of-raw-reads" class="level3"><h3 class="anchored" data-anchor-id="quality-control-of-raw-reads">1. Quality control of raw reads</h3>
<ul>
<li>FastQC: https://www.bioinformatics.babraham.ac.uk/projects/fastqc/</li>
</ul></section><section id="quantify-expression" class="level3"><h3 class="anchored" data-anchor-id="quantify-expression">2. Quantify expression</h3>
<p>To identify from which transcript each of the reads originated from and the total number of reads associated with each transcript. Lightweight alignment tools &amp; avoid base-to-base genomic alignment of the reads * Kallisto * Sailfish * Salmon</p>
<p>Genomic alignment Splice aware alignment tools * STAR * HISAT2</p>
<p>Quality control of aligned reads</p>
<ul>
<li>QualiMap: https://qualimap.bioinfo.cipf.es/
<ul>
<li>DNA or rRNA contamination</li>
<li>5’ to 3’ bias</li>
<li>Coverage biases</li>
</ul>
</li>
</ul>
<p>Quantification tools * featureCounts (subread package) * HTSeq-count</p>
<p><a href="deseq_counts_overview.png"></a></p>
<div class="callout-Note">
<p>The higher number of counts indicates more reads are associated with that gene and suggests a higher expression of that gene. However, this is not necessarily true, as the number of reads associated with a gene is also dependent on: - The length of the gene: longer genes will have more reads associated with them, even if they are expressed at the same level as shorter genes. - The sequencing depth: samples with more total reads will have more reads associated with each gene.</p>
</div>
<p>The above tools only report the “raw” counts of reads that map to a single location (uniquely mapping) and are best at counting at the gene level. Essentially, total read count associated with a gene (meta-feature) = the sum of reads associated with each of the exons (feature) that “belong” to that gene.</p>
<p>There are other tools available that are able to account for multiple transcripts for a given gene. In this case the counts are not whole numbers, but have fractions. In the simplest example case, if 1 read is associated with 2 transcripts, it can get counted as 0.5 and 0.5 and the resulting count for that transcript is not a whole number.</p>
<p>In addition there are other tools that will count multimapping reads, but this is a dangerous thing to do since you will be overcounting the total number of reads which can cause issues with normalization and eventually with accuracy of differential gene expression results.</p>
</section></section><section id="normalization" class="level2"><h2 class="anchored" data-anchor-id="normalization">Normalization</h2>
<p>The counts of mapped reads for each gene is proportional to the expression of RNA (“interesting”) in addition to many other factors (“uninteresting”). Normalization is the process of scaling raw count values to account for the “uninteresting” factors. In this way the expression levels are more comparable between and/or within samples.</p>
<ul>
<li>
<strong>Sequencing depth</strong>: total number of reads sequenced for a sample. Accounting for sequencing depth is necessary for comparison of gene expression between samples. In the example below, each gene appears to have doubled in expression in Sample A relative to Sample B, however this is a consequence of Sample A having double the sequencing depth.</li>
</ul>
<p><img src="normalization_methods_depth.png" width="400"></p>
<ul>
<li>
<strong>Gene length</strong>: Accounting for gene length is necessary for comparing expression between different genes within the same sample. In the example, Gene X and Gene Y have similar levels of expression, but the number of reads mapped to Gene X would be many more than the number mapped to Gene Y because Gene X is longer.</li>
</ul>
<p><img src="normalization_methods_length.png" width="200"></p>
<ul>
<li>
<strong>RNA composition</strong>: A few highly differentially expressed genes between samples, differences in the number of genes expressed between samples, or presence of contamination can skew some types of normalization methods. Accounting for RNA composition is recommended for accurate comparison of expression between samples, and is particularly important when performing differential expression analyses [1].</li>
</ul>
<p>In the example, if we were to divide each sample by the total number of counts to normalize, the counts would be greatly skewed by the DE gene, which takes up most of the counts for Sample A, but not Sample B. Most other genes for Sample A would be divided by the larger number of total counts and appear to be less expressed than those same genes in Sample B. <img src="normalization_methods_composition.png" width="400"></p>
<ul>
<li><strong>While normalization is essential for differential expression analyses, it is also necessary for exploratory data analysis, visualization of data, and whenever you are exploring or comparing counts between or within samples.</strong></li>
</ul>
<p>Several common normalization methods have been developed to account for these differences:</p>
<table class="caption-top table">
<thead><tr class="header">
<th style="text-align: center;">Normalization method</th>
<th style="text-align: center;">Description</th>
<th style="text-align: center;">Accounted factors</th>
<th style="text-align: center;">Recommendations for use</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">
<strong>CPM</strong> (counts per million)</td>
<td style="text-align: center;">counts scaled by total number of reads</td>
<td style="text-align: center;">sequencing depth</td>
<td style="text-align: center;">gene count comparisons between replicates of the same sample group; <strong>NOT for within sample comparisons or DE analysis</strong>
</td>
</tr>
<tr class="even">
<td style="text-align: center;">
<strong>TPM</strong> (transcripts per kilobase million)</td>
<td style="text-align: center;">counts per length of transcript (kb) per million reads mapped</td>
<td style="text-align: center;">sequencing depth and gene length</td>
<td style="text-align: center;">gene count comparisons within a sample or between samples of the same sample group; <strong>NOT for DE analysis</strong>
</td>
</tr>
<tr class="odd">
<td style="text-align: center;">
<strong>RPKM/FPKM</strong> (reads/fragments per kilobase of exon per million reads/fragments mapped)</td>
<td style="text-align: center;">similar to TPM</td>
<td style="text-align: center;">sequencing depth and gene length</td>
<td style="text-align: center;">gene count comparisons between genes within a sample; <strong>NOT for between sample comparisons or DE analysis</strong>
</td>
</tr>
<tr class="even">
<td style="text-align: center;">DESeq2’s <strong>median of ratios</strong> [<a href="https://genomebiology.biomedcentral.com/articles/10.1186/gb-2010-11-10-r106">1</a>]</td>
<td style="text-align: center;">counts divided by sample-specific size factors determined by median ratio of gene counts relative to geometric mean per gene</td>
<td style="text-align: center;">sequencing depth and RNA composition</td>
<td style="text-align: center;">gene count comparisons between samples and for <strong>DE analysis</strong>; <strong>NOT for within sample comparisons</strong>
</td>
</tr>
<tr class="odd">
<td style="text-align: center;">EdgeR’s <strong>trimmed mean of M values (TMM)</strong> [<a href="https://genomebiology.biomedcentral.com/articles/10.1186/gb-2010-11-3-r25">2</a>]</td>
<td style="text-align: center;">uses a weighted trimmed mean of the log expression ratios between samples</td>
<td style="text-align: center;">sequencing depth and RNA composition</td>
<td style="text-align: center;">gene count comparisons between samples and for <strong>DE analysis</strong>; <strong>NOT for within sample comparisons</strong>
</td>
</tr>
</tbody>
</table>
<p><strong>RPKM/FPKM: not recommended for between sample comparisons</strong></p>
<p>While TPM and RPKM/FPKM normalization methods both account for sequencing depth and gene length, RPKM/FPKM are not recommended. <strong>The reason is that the normalized count values output by the RPKM/FPKM method are not comparable between samples.</strong></p>
<p>Using RPKM/FPKM normalization, the total number of RPKM/FPKM normalized counts for each sample will be different. Therefore, you cannot compare the normalized counts for each gene equally between samples.</p>
<p><strong>RPKM-normalized counts table</strong></p>
<table class="caption-top table">
<thead><tr class="header">
<th style="text-align: center;">gene</th>
<th style="text-align: center;">sampleA</th>
<th style="text-align: center;">sampleB</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">XCR1</td>
<td style="text-align: center;">5.5</td>
<td style="text-align: center;">5.5</td>
</tr>
<tr class="even">
<td style="text-align: center;">WASHC1</td>
<td style="text-align: center;">73.4</td>
<td style="text-align: center;">21.8</td>
</tr>
<tr class="odd">
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
</tr>
<tr class="even">
<td style="text-align: center;">Total RPKM-normalized counts</td>
<td style="text-align: center;">1,000,000</td>
<td style="text-align: center;">1,500,000</td>
</tr>
</tbody>
</table>
<p>For example, in the table above, sampleA has a greater proportion of counts associated with XCR1 (5.5/1,000,000) than sampleB (5.5/1,500,000), even though the RPKM count values are the same. Therefore, we cannot directly compare the counts for XCR1 (or any other gene) between sampleA and sampleB, because the total number of normalized counts are different between samples.</p>
<section id="deseq2-normalized-counts-median-of-ratios-method" class="level3"><h3 class="anchored" data-anchor-id="deseq2-normalized-counts-median-of-ratios-method">DESeq2-normalized counts: Median of ratios method</h3>
<p>Since tools for differential expression analysis are comparing the counts of the same gene between sample groups, gene length does not need to be accounted for by the tool. However, <strong>sequencing depth</strong> and <strong>RNA composition</strong> do need to be taken into account.</p>
<p>To normalize for sequencing depth and RNA composition, DESeq2 uses the median of ratios method. On the user-end there is only one step, but on the back-end there are multiple steps involved, as described below.</p>
<div class="{callout-note}">
<p>The steps below describe in detail some of the steps performed by DESeq2 when you run a single function to get DE genes. Basically, for a typical RNA-seq analysis, <strong>you would not run these steps individually</strong>.</p>
</div>
<p><strong>Step 1: creates a pseudo-reference sample (row-wise geometric mean)</strong></p>
<p>For each gene, a pseudo-reference sample is created that is equal to the geometric mean across all samples.</p>
<table class="caption-top table">
<thead><tr class="header">
<th style="text-align: center;">gene</th>
<th style="text-align: center;">sampleA</th>
<th style="text-align: center;">sampleB</th>
<th style="text-align: center;">pseudo-reference sample</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">EF2A</td>
<td style="text-align: center;">1489</td>
<td style="text-align: center;">906</td>
<td style="text-align: center;">sqrt(1489 * 906) = <strong>1161.5</strong>
</td>
</tr>
<tr class="even">
<td style="text-align: center;">ABCD1</td>
<td style="text-align: center;">22</td>
<td style="text-align: center;">13</td>
<td style="text-align: center;">sqrt(22 * 13) = <strong>17.7</strong>
</td>
</tr>
<tr class="odd">
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
</tr>
</tbody>
</table>
<p><strong>Step 2: calculates ratio of each sample to the reference</strong></p>
<p>For every gene in every sample, the ratios (sample/ref) are calculated (as shown below). Since the majority of genes are not differentially expressed, the majority of genes in each sample should have similar ratios within the sample.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
<col style="width: 16%">
</colgroup>
<thead><tr class="header">
<th style="text-align: center;">gene</th>
<th style="text-align: center;">sampleA</th>
<th style="text-align: center;">sampleB</th>
<th style="text-align: center;">pseudo-reference sample</th>
<th style="text-align: center;">ratio of sampleA/ref</th>
<th style="text-align: center;">ratio of sampleB/ref</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">EF2A</td>
<td style="text-align: center;">1489</td>
<td style="text-align: center;">906</td>
<td style="text-align: center;">1161.5</td>
<td style="text-align: center;">1489/1161.5 = <strong>1.28</strong>
</td>
<td style="text-align: center;">906/1161.5 = <strong>0.78</strong>
</td>
</tr>
<tr class="even">
<td style="text-align: center;">ABCD1</td>
<td style="text-align: center;">22</td>
<td style="text-align: center;">13</td>
<td style="text-align: center;">16.9</td>
<td style="text-align: center;">22/16.9 = <strong>1.30</strong>
</td>
<td style="text-align: center;">13/16.9 = <strong>0.77</strong>
</td>
</tr>
<tr class="odd">
<td style="text-align: center;">MEFV</td>
<td style="text-align: center;">793</td>
<td style="text-align: center;">410</td>
<td style="text-align: center;">570.2</td>
<td style="text-align: center;">793/570.2 = <strong>1.39</strong>
</td>
<td style="text-align: center;">410/570.2 = <strong>0.72</strong>
</td>
</tr>
<tr class="even">
<td style="text-align: center;">BAG1</td>
<td style="text-align: center;">76</td>
<td style="text-align: center;">42</td>
<td style="text-align: center;">56.5</td>
<td style="text-align: center;">76/56.5 = <strong>1.35</strong>
</td>
<td style="text-align: center;">42/56.5 = <strong>0.74</strong>
</td>
</tr>
<tr class="odd">
<td style="text-align: center;">MOV10</td>
<td style="text-align: center;">521</td>
<td style="text-align: center;">1196</td>
<td style="text-align: center;">883.7</td>
<td style="text-align: center;">521/883.7 = <strong>0.590</strong>
</td>
<td style="text-align: center;">1196/883.7 = <strong>1.35</strong>
</td>
</tr>
<tr class="even">
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
</tbody>
</table>
<p><strong>Step 3: calculate the normalization factor for each sample (size factor)</strong></p>
<p>The median value (column-wise for the above table) of all ratios for a given sample is taken as the normalization factor (size factor) for that sample, as calculated below. Notice that the differentially expressed genes should not affect the median value:</p>
<p><code>normalization_factor_sampleA &lt;- median(c(1.28, 1.3, 1.39, 1.35, 0.59))</code></p>
<p><code>normalization_factor_sampleB &lt;- median(c(0.78, 0.77, 0.72, 0.74, 1.35))</code></p>
<p>The figure below illustrates the median value for the distribution of all gene ratios for a single sample (y-axis is the frequency).</p>
<p><img src="deseq_median_of_ratios.png" width="400"></p>
<p>The median of ratios method makes the assumption that not ALL genes are differentially expressed; therefore, the normalization factors should account for sequencing depth and RNA composition of the sample (large outlier genes will not affect the median ratio values). <strong>This method is robust to imbalance in up-/down-regulation and large numbers of differentially expressed genes.</strong></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Usually these size factors are around 1. If you see large variations between samples, it is important to take note as it might indicate the presence of extreme outliers.</p>
</div>
</div>
<p><strong>Step 4: calculate the normalized count values using the normalization factor</strong></p>
<p>This is performed by dividing each raw count value in a given sample by that sample’s normalization factor, generating normalized count values. This is performed for all count values (every gene in every sample). For example, if the median ratio for sampleA was 1.3 and the median ratio for sampleB was 0.77, you could calculate normalized counts as follows:</p>
<p><strong>Raw Counts</strong></p>
<table class="caption-top table">
<thead><tr class="header">
<th style="text-align: center;">gene</th>
<th style="text-align: center;">sampleA</th>
<th style="text-align: center;">sampleB</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">EF2A</td>
<td style="text-align: center;">1489</td>
<td style="text-align: center;">906</td>
</tr>
<tr class="even">
<td style="text-align: center;">ABCD1</td>
<td style="text-align: center;">22</td>
<td style="text-align: center;">13</td>
</tr>
<tr class="odd">
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
</tr>
</tbody>
</table>
<p><strong>Normalized Counts</strong></p>
<table class="caption-top table">
<thead><tr class="header">
<th style="text-align: center;">gene</th>
<th style="text-align: center;">sampleA</th>
<th style="text-align: center;">sampleB</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">EF2A</td>
<td style="text-align: center;">1489 / 1.3 = <strong>1145.39</strong>
</td>
<td style="text-align: center;">906 / 0.77 = <strong>1176.62</strong>
</td>
</tr>
<tr class="even">
<td style="text-align: center;">ABCD1</td>
<td style="text-align: center;">22 / 1.3 = <strong>16.92</strong>
</td>
<td style="text-align: center;">13 / 0.77 = <strong>16.88</strong>
</td>
</tr>
<tr class="odd">
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
<td style="text-align: center;">…</td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Please note that normalized count values are not whole numbers.</p>
</div>
</div>
<hr></section></section><section id="count-normalization-of-mov10-dataset-using-deseq2" class="level2 page-columns page-full"><h2 class="anchored" data-anchor-id="count-normalization-of-mov10-dataset-using-deseq2">Count normalization of Mov10 dataset using DESeq2</h2>
<p>Now that we know the theory of count normalization, we will normalize the counts for the Mov10 dataset using DESeq2. This requires a few steps:</p>
<ol type="1">
<li>Ensure that the row names of the metadata dataframe are present and are in the same order as the column names of the counts dataframe.</li>
<li>Create a <code>DESeqDataSet</code> object</li>
<li>Generate the normalized counts</li>
</ol>
<section id="match-the-metadata-and-counts-data" class="level3"><h3 class="anchored" data-anchor-id="match-the-metadata-and-counts-data">1. Match the metadata and counts data</h3>
<p>We should always make sure that we have sample names that match between the two files, and that the samples are in the same order. DESeq2 will output an error if this is not the case.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Check that sample names match in both files</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">txi</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">meta</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">txi</span><span class="op">$</span><span class="va">counts</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">meta</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>If your data does not match, you could use the <code><a href="https://rdrr.io/r/base/match.html">match()</a></code> function to rearrange them.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span><a href="05_DGE_count_normalization_Answers.html#exercise-1"><strong>Exercise 1</strong></a>
</div>
</div>
<div class="callout-body-container callout-body">
<p>Suppose we have sample names matching in the counts matrix and metadata file, but they are in different order. Write the line(s) of code to create a new matrix with columns re-ordered such that they are identical to the row names of the metadata.</p>
</div>
</div>
</section><section id="create-deseq2-object" class="level3 page-columns page-full"><h3 class="anchored" data-anchor-id="create-deseq2-object">2. Create DESEq2 object</h3>
<p>Bioconductor software packages often define and use a custom class within R for storing data (input data, intermediate data and also results). These custom data structures are similar to <code>lists</code> in that they can contain multiple different data types/structures. But unlike lists, they have pre-specified <strong>data slots</strong>, which hold specific types/classes of data. The data stored in these pre-specified slots can be accessed by using specific package-defined functions.</p>
<p>Let’s start by creating the <code>DESeqDataSet</code> object, and then we can talk a bit more about what is stored inside it. To create the object, we will need the <strong>count matrix</strong> and the <strong>metadata</strong> table as input. We will also need to specify a <strong>design formula</strong>. The design formula specifies the column(s) in the metadata table and how they should be used in the analysis. For our dataset we only have one column we are interested in, which is <code>~sampletype</code>. This column has three factor levels, which tells DESeq2 that for each gene we want to evaluate gene expression change with respect to these different levels.</p>
<p><strong>Our count matrix input is stored in the <code>txi</code> list object</strong>. So we need to specify that using the <code>DESeqDataSetFromTximport()</code> function, which will extract the counts component and round the values to the nearest whole number.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create DESeq2Dataset object</span></span>
<span><span class="va">dds</span> <span class="op">&lt;-</span> <span class="fu">DESeqDataSetFromTximport</span><span class="op">(</span><span class="va">txi</span>, colData <span class="op">=</span> <span class="va">meta</span>, design <span class="op">=</span> <span class="op">~</span> <span class="va">sampletype</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Since we had created a <code>data</code> variable in the last lesson that contains the counts, we could have also used that as input. However, in that case we would want to use the <code>DESeqDataSetFromMatrix()</code> function.</p>
</div>
</div>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full"><p><img src="../img/deseq_obj1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">DESeq2 object structure</figcaption></figure>
</div>
<p>You can use DESeq-specific functions to access the different slots and retrieve information. For example, suppose we want to retrieve the original count matrix, we would use <code>counts()</code> function (<em>Note: we nest it within the <code><a href="https://rdrr.io/r/utils/head.html">head()</a></code> function so that we can see just the first few lines of the matrix. You could also use the <code><a href="https://rdrr.io/r/utils/View.html">View()</a></code> function to view the result in the script editor rather than in the console</em>):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">counts</span><span class="op">(</span><span class="va">dds</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>As we go through the workflow, we will use relevant functions to check what information is stored inside our object.</p>
</section><section id="generate-the-mov10-normalized-counts" class="level3"><h3 class="anchored" data-anchor-id="generate-the-mov10-normalized-counts">3. Generate the Mov10 normalized counts</h3>
<p>The next step is to normalize the count data in order to make fair gene comparisons between samples.</p>
<p><img src="../img/de_workflow_salmon_normalization.png" width="400"></p>
<p>To perform the <strong>median of ratios method</strong> of normalization, DESeq2 has a single <code>estimateSizeFactors()</code> function that will generate size factors. We will demonstrate this function in the example below, but <strong>in a typical RNA-seq analysis, this step is automatically performed by the <code>DESeq()</code> function</strong>, which we will discuss later.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Estimate size factors</span></span>
<span><span class="va">dds</span> <span class="op">&lt;-</span> <span class="fu">estimateSizeFactors</span><span class="op">(</span><span class="va">dds</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>By assigning the results back to the <code>dds</code> object, we are filling in the slots of the <code>DESeqDataSet</code> object with the appropriate information. We can take a look at the normalization factors of each sample using:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Look at size factors</span></span>
<span><span class="fu">sizeFactors</span><span class="op">(</span><span class="va">dds</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now, to retrieve the normalized counts matrix from <code>dds</code>, we use the <code>counts()</code> function and add the argument <code>normalized=TRUE</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Get normalized counts matrix</span></span>
<span><span class="va">normalized_counts</span> <span class="op">&lt;-</span> <span class="fu">counts</span><span class="op">(</span><span class="va">dds</span>, normalized<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We can save this normalized data matrix to file for later use:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Save normalized counts matrix</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.table</a></span><span class="op">(</span><span class="va">normalized_counts</span>, file<span class="op">=</span><span class="st">"./data/normalized_counts.txt"</span>, sep<span class="op">=</span><span class="st">"\t"</span>, quote<span class="op">=</span><span class="cn">FALSE</span>, col.names <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>DESeq2 doesn’t actually use normalized counts; rather it uses the raw counts and models the normalization inside the Generalized Linear Model (GLM). These normalized counts will be useful for downstream visualization of results, but cannot be used as input to DESeq2 or any other tools that perform differential expression analysis that use the negative binomial model.</p>
</div>
</div>
</section></section><section id="deg-analysis-tools" class="level2"><h2 class="anchored" data-anchor-id="deg-analysis-tools">DEG Analysis Tools</h2>
</section><section id="bulk-rna-seq-vs-single-cell-rna-seq" class="level2"><h2 class="anchored" data-anchor-id="bulk-rna-seq-vs-single-cell-rna-seq">Bulk RNA-seq vs Single-Cell RNA-seq</h2>
<ul>
<li>Cheaper</li>
<li>Simpler</li>
<li>Statistically stronger with replicates</li>
</ul>
<p>Suitable for: ✔️ Homogeneous samples (like cell lines) ✔️ High-throughput designs with many conditions ✔️ Studies where replication is key (e.g., drug treatments, time-course) ✔️ Situations where per-cell resolution won’t change your biological conclusion</p>
</section><section id="single-cell-rna-seq" class="level2"><h2 class="anchored" data-anchor-id="single-cell-rna-seq">Single-Cell RNA-seq</h2>
<p>Use scRNA-seq if your question depends on:</p>
<ul>
<li>Detecting rare populations</li>
<li>Disentangling heterogeneous tissues</li>
<li>Discovering cell-type-specific signals</li>
</ul>
<p>In these cases, resolution matters—and scRNA-seq earns its price tag.</p>
<p>But know this: you’re trading off simplicity, QC, and replicability.</p>
</section><section id="reference" class="level2"><h2 class="anchored" data-anchor-id="reference">Reference</h2>
<ul>
<li><a href="https://hbctraining.github.io/Intro-to-bulk-RNAseq/schedule/links-to-lessons.html">Introduction to bulk RNA-seq: From reads to count matrix</a></li>
</ul>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/grgrzhong\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p><span class="faux-block"><i class="fa-brands fa-creative-commons" aria-label="creative-commons"></i> 2021-2025 Guorui Zhong ~ Made with <a href="https://www.r-project.org/"><i class="fa-brands fa-r-project" aria-label="r-project"></i></a> and <a href="https://quarto.org/">Quarto</a></span></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


</body></html>